(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[15],{"16Y1":function(e,t,n){e.exports=n.p+"static/fiber-effectlist.9f96bfb9.png"},EHsg:function(e,t,n){e.exports=n.p+"static/fibertree-beforecommit.a32107ef.png"},ER0E:function(e,t,n){"use strict";n.r(t);var l=n("q1tI"),a=n.n(l),c=n("dEAq"),o=n("H1Ra"),r=a.a.memo((e=>{e.demos;return a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"markdown"},a.a.createElement("h1",{id:"fiber-\u6811\u6e32\u67d3"},a.a.createElement(c["AnchorLink"],{to:"#fiber-\u6811\u6e32\u67d3","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"fiber \u6811\u6e32\u67d3"),a.a.createElement("p",null,"\u5728\u6b63\u5f0f\u5206\u6790",a.a.createElement("code",null,"fiber\u6811\u6e32\u67d3"),"\u4e4b\u524d, \u518d\u6b21\u56de\u987e\u4e00\u4e0b",a.a.createElement(c["Link"],{to:"./reconciler-workflow"},"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"\u7684 4 \u4e2a\u9636\u6bb5:"),a.a.createElement("p",null,a.a.createElement("img",{src:n("wOdG"),alt:""})),a.a.createElement("ol",null,a.a.createElement("li",null,"\u8f93\u5165\u9636\u6bb5: \u8854\u63a5",a.a.createElement("code",null,"react-dom"),"\u5305, \u627f\u63a5",a.a.createElement("code",null,"fiber\u66f4\u65b0"),"\u8bf7\u6c42(\u53c2\u8003",a.a.createElement(c["Link"],{to:"./bootstrap"},"React \u5e94\u7528\u7684\u542f\u52a8\u8fc7\u7a0b"),")."),a.a.createElement("li",null,"\u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1: \u4e0e\u8c03\u5ea6\u4e2d\u5fc3(",a.a.createElement("code",null,"scheduler"),"\u5305)\u4ea4\u4e92, \u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1",a.a.createElement("code",null,"task"),", \u7b49\u5f85\u4efb\u52a1\u56de\u8c03(\u53c2\u8003",a.a.createElement(c["Link"],{to:"./scheduler"},"React \u8c03\u5ea6\u539f\u7406(scheduler)"),")."),a.a.createElement("li",null,"\u6267\u884c\u4efb\u52a1\u56de\u8c03: \u5728\u5185\u5b58\u4e2d\u6784\u9020\u51fa",a.a.createElement("code",null,"fiber\u6811"),"\u548c",a.a.createElement("code",null,"DOM"),"\u5bf9\u8c61(\u53c2\u8003",a.a.createElement(c["Link"],{to:"./fibertree-create"},"fiber \u6811\u6784\u9020(\u521d\u6b21\u521b\u5efa)"),"\u548c fiber \u6811\u6784\u9020(\u5bf9\u6bd4\u66f4\u65b0))."),a.a.createElement("li",null,"\u8f93\u51fa: \u4e0e\u6e32\u67d3\u5668(",a.a.createElement("code",null,"react-dom"),")\u4ea4\u4e92, \u6e32\u67d3",a.a.createElement("code",null,"DOM"),"\u8282\u70b9.")),a.a.createElement("p",null,"\u672c\u8282\u5206\u6790\u5176\u4e2d\u7684\u7b2c 4 \u9636\u6bb5(\u8f93\u51fa), ",a.a.createElement("code",null,"fiber\u6811\u6e32\u67d3"),"\u5904\u4e8e",a.a.createElement("code",null,"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"\u8fd9\u4e00\u6d41\u6c34\u7ebf\u7684\u6700\u540e\u4e00\u73af, \u6216\u8005\u8bf4\u524d\u9762\u7684\u6b65\u9aa4\u90fd\u662f\u4e3a\u4e86\u6700\u540e\u4e00\u6b65\u670d\u52a1, \u6240\u4ee5\u5176\u91cd\u8981\u6027\u4e0d\u8a00\u800c\u55bb."),a.a.createElement("p",null,"\u524d\u6587\u5df2\u7ecf\u4ecb\u7ecd\u4e86",a.a.createElement("code",null,"fiber\u6811\u6784\u9020"),", \u73b0\u5728\u5206\u6790",a.a.createElement("code",null,"fiber\u6811\u6e32\u67d3"),"\u8fc7\u7a0b, \u8fd9\u4e2a\u8fc7\u7a0b, \u5b9e\u9645\u4e0a\u662f\u5bf9",a.a.createElement("code",null,"fiber\u6811"),"\u7684\u8fdb\u4e00\u6b65\u5904\u7406."),a.a.createElement("h2",{id:"fiber-\u6811\u7279\u70b9"},a.a.createElement(c["AnchorLink"],{to:"#fiber-\u6811\u7279\u70b9","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"fiber \u6811\u7279\u70b9"),a.a.createElement("p",null,"\u901a\u8fc7\u524d\u6587",a.a.createElement("code",null,"fiber\u6811\u6784\u9020"),"\u7684\u89e3\u8bfb, \u53ef\u4ee5\u603b\u7ed3\u51fa",a.a.createElement("code",null,"fiber\u6811"),"\u7684\u57fa\u672c\u7279\u70b9:"),a.a.createElement("ul",null,a.a.createElement("li",null,"\u65e0\u8bba\u662f",a.a.createElement("code",null,"\u9996\u6b21\u6784\u9020"),"\u6216\u8005\u662f",a.a.createElement("code",null,"\u5bf9\u6bd4\u66f4\u65b0"),", \u6700\u7ec8\u90fd\u4f1a\u5728\u5185\u5b58\u4e2d\u751f\u6210\u4e00\u68f5\u7528\u4e8e\u6e32\u67d3\u9875\u9762\u7684",a.a.createElement("code",null,"fiber\u6811"),"(\u5373",a.a.createElement("code",null,"fiberRoot.finishedWork"),")."),a.a.createElement("li",null,"\u8fd9\u68f5\u5c06\u8981\u88ab\u6e32\u67d3\u7684",a.a.createElement("code",null,"fiber\u6811"),"\u6709 2 \u4e2a\u7279\u70b9:",a.a.createElement("ol",null,a.a.createElement("li",null,"\u526f\u4f5c\u7528\u961f\u5217\u6302\u8f7d\u5728\u6839\u8282\u70b9\u4e0a(\u5177\u4f53\u6765\u8bb2\u662f",a.a.createElement("code",null,"finishedWork.firstEffect"),")"),a.a.createElement("li",null,"\u4ee3\u8868\u6700\u65b0\u9875\u9762\u7684",a.a.createElement("code",null,"DOM"),"\u5bf9\u8c61\u6302\u8f7d\u5728",a.a.createElement("code",null,"fiber\u6811"),"\u4e2d\u9996\u4e2a",a.a.createElement("code",null,"HostComponent"),"\u7c7b\u578b\u7684\u8282\u70b9\u4e0a(\u5177\u4f53\u6765\u8bb2",a.a.createElement("code",null,"DOM"),"\u5bf9\u8c61\u662f\u6302\u8f7d\u5728",a.a.createElement("code",null,"fiber.stateNode"),"\u5c5e\u6027\u4e0a)")))),a.a.createElement("p",null,"\u8fd9\u91cc\u518d\u6b21\u56de\u987e\u524d\u6587\u4f7f\u7528\u8fc7\u7684 2 \u68f5 fiber \u6811, \u53ef\u4ee5\u9a8c\u8bc1\u4e0a\u8ff0\u7279\u70b9:"),a.a.createElement("ol",null,a.a.createElement("li",null,"\u521d\u6b21\u6784\u9020")),a.a.createElement("p",null,a.a.createElement("img",{src:n("EHsg"),alt:""})),a.a.createElement("ol",{start:2},a.a.createElement("li",null,"\u5bf9\u6bd4\u66f4\u65b0")),a.a.createElement("p",null,a.a.createElement("img",{src:n("sD8s"),alt:""})),a.a.createElement("h2",{id:"commitroot"},a.a.createElement(c["AnchorLink"],{to:"#commitroot","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"commitRoot"),a.a.createElement("p",null,"\u6574\u4e2a\u6e32\u67d3\u903b\u8f91\u90fd\u5728",a.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1879-L2254"},"commitRoot \u51fd\u6570\u4e2d"),":"),a.a.createElement(o["a"],{code:"function commitRoot(root) {\n  const renderPriorityLevel = getCurrentPriorityLevel();\n  runWithPriority(\n    ImmediateSchedulerPriority,\n    commitRootImpl.bind(null, root, renderPriorityLevel),\n  );\n  return null;\n}",lang:"js"}),a.a.createElement("p",null,"\u5728",a.a.createElement("code",null,"commitRoot"),"\u4e2d\u540c\u65f6\u4f7f\u7528\u5230\u4e86",a.a.createElement("code",null,"\u6e32\u67d3\u4f18\u5148\u7ea7"),"\u548c",a.a.createElement("code",null,"\u8c03\u5ea6\u4f18\u5148\u7ea7"),", \u6709\u5173\u4f18\u5148\u7ea7\u7684\u8ba8\u8bba, \u5728\u524d\u6587\u5df2\u7ecf\u505a\u51fa\u4e86\u8bf4\u660e(\u53c2\u8003",a.a.createElement(c["Link"],{to:"./priority"},"React \u4e2d\u7684\u4f18\u5148\u7ea7\u7ba1\u7406"),"\u548c",a.a.createElement(c["AnchorLink"],{to:"./fibertree-prepare#%E4%BC%98%E5%85%88%E7%BA%A7"},"fiber \u6811\u6784\u9020(\u57fa\u7840\u51c6\u5907)#\u4f18\u5148\u7ea7"),"), \u672c\u8282\u4e0d\u518d\u8d58\u8ff0. \u6700\u540e\u7684\u5b9e\u73b0\u662f\u901a\u8fc7",a.a.createElement("code",null,"commitRootImpl"),"\u51fd\u6570:"),a.a.createElement(o["a"],{code:"// ... \u7701\u7565\u90e8\u5206\u65e0\u5173\u4ee3\u7801\nfunction commitRootImpl(root, renderPriorityLevel) {\n  // ============ \u6e32\u67d3\u524d: \u51c6\u5907 ============\n\n  const finishedWork = root.finishedWork;\n  const lanes = root.finishedLanes;\n\n  // \u6e05\u7a7aFiberRoot\u5bf9\u8c61\u4e0a\u7684\u5c5e\u6027\n  root.finishedWork = null;\n  root.finishedLanes = NoLanes;\n  root.callbackNode = null;\n\n  if (root === workInProgressRoot) {\n    // \u91cd\u7f6e\u5168\u5c40\u53d8\u91cf\n    workInProgressRoot = null;\n    workInProgress = null;\n    workInProgressRootRenderLanes = NoLanes;\n  }\n\n  // \u518d\u6b21\u66f4\u65b0\u526f\u4f5c\u7528\u961f\u5217\n  let firstEffect;\n  if (finishedWork.flags > PerformedWork) {\n    // \u9ed8\u8ba4\u60c5\u51b5\u4e0bfiber\u8282\u70b9\u7684\u526f\u4f5c\u7528\u961f\u5217\u662f\u4e0d\u5305\u62ec\u81ea\u8eab\u7684\n    // \u5982\u679c\u6839\u8282\u70b9\u6709\u526f\u4f5c\u7528, \u5219\u5c06\u6839\u8282\u70b9\u6dfb\u52a0\u5230\u526f\u4f5c\u7528\u961f\u5217\u7684\u672b\u5c3e\n    if (finishedWork.lastEffect !== null) {\n      finishedWork.lastEffect.nextEffect = finishedWork;\n      firstEffect = finishedWork.firstEffect;\n    } else {\n      firstEffect = finishedWork;\n    }\n  } else {\n    firstEffect = finishedWork.firstEffect;\n  }\n\n  // ============ \u6e32\u67d3 ============\n  let firstEffect = finishedWork.firstEffect;\n  if (firstEffect !== null) {\n    const prevExecutionContext = executionContext;\n    executionContext |= CommitContext;\n    // \u9636\u6bb51: dom\u7a81\u53d8\u4e4b\u524d\n    nextEffect = firstEffect;\n    do {\n      commitBeforeMutationEffects();\n    } while (nextEffect !== null);\n\n    // \u9636\u6bb52: dom\u7a81\u53d8, \u754c\u9762\u53d1\u751f\u6539\u53d8\n    nextEffect = firstEffect;\n    do {\n      commitMutationEffects(root, renderPriorityLevel);\n    } while (nextEffect !== null);\n    // \u6062\u590d\u754c\u9762\u72b6\u6001\n    resetAfterCommit(root.containerInfo);\n    // \u5207\u6362current\u6307\u9488\n    root.current = finishedWork;\n\n    // \u9636\u6bb53: layout\u9636\u6bb5, \u8c03\u7528\u751f\u547d\u5468\u671fcomponentDidUpdate\u548c\u56de\u8c03\u51fd\u6570\u7b49\n    nextEffect = firstEffect;\n    do {\n      commitLayoutEffects(root, lanes);\n    } while (nextEffect !== null);\n    nextEffect = null;\n    executionContext = prevExecutionContext;\n  }\n\n  // ============ \u6e32\u67d3\u540e: \u91cd\u7f6e\u4e0e\u6e05\u7406 ============\n  if (rootDoesHavePassiveEffects) {\n    // \u6709\u88ab\u52a8\u4f5c\u7528(\u4f7f\u7528useEffect), \u4fdd\u5b58\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\n  } else {\n    // \u5206\u89e3\u526f\u4f5c\u7528\u961f\u5217\u94fe\u8868, \u8f85\u52a9\u5783\u573e\u56de\u6536\n    // \u5982\u679c\u6709\u88ab\u52a8\u4f5c\u7528(\u4f7f\u7528useEffect), \u4f1a\u628a\u5206\u89e3\u64cd\u4f5c\u653e\u5728flushPassiveEffects\u51fd\u6570\u4e2d\n    nextEffect = firstEffect;\n    while (nextEffect !== null) {\n      const nextNextEffect = nextEffect.nextEffect;\n      nextEffect.nextEffect = null;\n      if (nextEffect.flags & Deletion) {\n        detachFiberAfterEffects(nextEffect);\n      }\n      nextEffect = nextNextEffect;\n    }\n  }\n  // \u91cd\u7f6e\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf(\u7701\u7565\u8fd9\u90e8\u5206\u4ee3\u7801)...\n  // \u4e0b\u9762\u4ee3\u7801\u7528\u4e8e\u68c0\u6d4b\u662f\u5426\u6709\u65b0\u7684\u66f4\u65b0\u4efb\u52a1\n  // \u6bd4\u5982\u5728componentDidMount\u51fd\u6570\u4e2d, \u518d\u6b21\u8c03\u7528setState()\n\n  // 1. \u68c0\u6d4b\u5e38\u89c4(\u5f02\u6b65)\u4efb\u52a1, \u5982\u679c\u6709\u5219\u4f1a\u53d1\u8d77\u5f02\u6b65\u8c03\u5ea6(\u8c03\u5ea6\u4e2d\u5fc3`scheduler`\u53ea\u80fd\u5f02\u6b65\u8c03\u7528)\n  ensureRootIsScheduled(root, now());\n  // 2. \u68c0\u6d4b\u540c\u6b65\u4efb\u52a1, \u5982\u679c\u6709\u5219\u4e3b\u52a8\u8c03\u7528flushSyncCallbackQueue(\u65e0\u9700\u518d\u6b21\u7b49\u5f85scheduler\u8c03\u5ea6), \u518d\u6b21\u8fdb\u5165fiber\u6811\u6784\u9020\u5faa\u73af\n  flushSyncCallbackQueue();\n\n  return null;\n}",lang:"js"}),a.a.createElement("p",null,a.a.createElement("code",null,"commitRootImpl"),"\u51fd\u6570\u4e2d, \u53ef\u4ee5\u6839\u636e\u662f\u5426\u8c03\u7528\u6e32\u67d3, \u628a\u6574\u4e2a",a.a.createElement("code",null,"commitRootImpl"),"\u5206\u4e3a 3 \u6bb5(\u5206\u522b\u662f",a.a.createElement("code",null,"\u6e32\u67d3\u524d"),", ",a.a.createElement("code",null,"\u6e32\u67d3"),", ",a.a.createElement("code",null,"\u6e32\u67d3\u540e"),")."),a.a.createElement("h3",{id:"\u6e32\u67d3\u524d"},a.a.createElement(c["AnchorLink"],{to:"#\u6e32\u67d3\u524d","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"\u6e32\u67d3\u524d"),a.a.createElement("p",null,"\u4e3a\u63a5\u4e0b\u6765\u6b63\u5f0f\u6e32\u67d3, \u505a\u4e00\u4e9b\u51c6\u5907\u5de5\u4f5c. \u4e3b\u8981\u5305\u62ec:"),a.a.createElement("ol",null,a.a.createElement("li",null,"\u8bbe\u7f6e\u5168\u5c40\u72b6\u6001(\u5982: \u66f4\u65b0",a.a.createElement("code",null,"fiberRoot"),"\u4e0a\u7684\u5c5e\u6027)"),a.a.createElement("li",null,"\u91cd\u7f6e\u5168\u5c40\u53d8\u91cf(\u5982: ",a.a.createElement("code",null,"workInProgressRoot"),", ",a.a.createElement("code",null,"workInProgress"),"\u7b49)"),a.a.createElement("li",null,"\u518d\u6b21\u66f4\u65b0\u526f\u4f5c\u7528\u961f\u5217: \u53ea\u9488\u5bf9\u6839\u8282\u70b9",a.a.createElement("code",null,"fiberRoot.finishedWork"),a.a.createElement("ul",null,a.a.createElement("li",null,"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6839\u8282\u70b9\u7684\u526f\u4f5c\u7528\u961f\u5217\u662f\u4e0d\u5305\u62ec\u81ea\u8eab\u7684, \u5982\u679c\u6839\u8282\u70b9\u6709\u526f\u4f5c\u7528, \u5219\u5c06\u6839\u8282\u70b9\u6dfb\u52a0\u5230\u526f\u4f5c\u7528\u961f\u5217\u7684\u672b\u5c3e"),a.a.createElement("li",null,"\u6ce8\u610f\u53ea\u662f\u5ef6\u957f\u4e86\u526f\u4f5c\u7528\u961f\u5217, \u4f46\u662f",a.a.createElement("code",null,"fiberRoot.lastEffect"),"\u6307\u9488\u5e76\u6ca1\u6709\u6539\u53d8. \u6bd4\u5982\u9996\u6b21\u6784\u9020\u65f6, \u6839\u8282\u70b9\u62e5\u6709",a.a.createElement("code",null,"Snapshot"),"\u6807\u8bb0:")))),a.a.createElement("p",null,a.a.createElement("img",{src:n("16Y1"),alt:""})),a.a.createElement("h3",{id:"\u6e32\u67d3"},a.a.createElement(c["AnchorLink"],{to:"#\u6e32\u67d3","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"\u6e32\u67d3"),a.a.createElement("p",null,a.a.createElement("code",null,"commitRootImpl"),"\u51fd\u6570\u4e2d, \u6e32\u67d3\u9636\u6bb5\u7684\u4e3b\u8981\u903b\u8f91\u662f\u5904\u7406\u526f\u4f5c\u7528\u961f\u5217, \u5c06\u6700\u65b0\u7684 DOM \u8282\u70b9(\u5df2\u7ecf\u5728\u5185\u5b58\u4e2d, \u53ea\u662f\u8fd8\u6ca1\u6e32\u67d3)\u6e32\u67d3\u5230\u754c\u9762\u4e0a."),a.a.createElement("p",null,"\u6574\u4e2a\u6e32\u67d3\u8fc7\u7a0b\u88ab\u5206\u4e3a 3 \u4e2a\u51fd\u6570\u5206\u5e03\u5b9e\u73b0:"),a.a.createElement("ol",null,a.a.createElement("li",null,a.a.createElement("code",null,"commitBeforeMutationEffects"),a.a.createElement("ul",null,a.a.createElement("li",null,"dom \u53d8\u66f4\u4e4b\u524d, \u5904\u7406\u526f\u4f5c\u7528\u961f\u5217\u4e2d\u5e26\u6709",a.a.createElement("code",null,"Snapshot"),",",a.a.createElement("code",null,"Passive"),"\u6807\u8bb0\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9."))),a.a.createElement("li",null,a.a.createElement("code",null,"commitMutationEffects"),a.a.createElement("ul",null,a.a.createElement("li",null,"dom \u53d8\u66f4, \u754c\u9762\u5f97\u5230\u66f4\u65b0. \u5904\u7406\u526f\u4f5c\u7528\u961f\u5217\u4e2d\u5e26\u6709",a.a.createElement("code",null,"Placement"),", ",a.a.createElement("code",null,"Update"),", ",a.a.createElement("code",null,"Deletion"),", ",a.a.createElement("code",null,"Hydrating"),"\u6807\u8bb0\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9."))),a.a.createElement("li",null,a.a.createElement("code",null,"commitLayoutEffects"),a.a.createElement("ul",null,a.a.createElement("li",null,"dom \u53d8\u66f4\u540e, \u5904\u7406\u526f\u4f5c\u7528\u961f\u5217\u4e2d\u5e26\u6709",a.a.createElement("code",null,"Update | Callback"),"\u6807\u8bb0\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9.")))),a.a.createElement("p",null,"\u901a\u8fc7\u4e0a\u8ff0\u6e90\u7801\u5206\u6790, \u53ef\u4ee5\u628a",a.a.createElement("code",null,"commitRootImpl"),"\u7684\u804c\u8d23\u6982\u62ec\u4e3a 2 \u4e2a\u65b9\u9762:"),a.a.createElement("ol",null,a.a.createElement("li",null,"\u5904\u7406\u526f\u4f5c\u7528\u961f\u5217. (\u6b65\u9aa4 1,2,3 \u90fd\u4f1a\u5904\u7406, \u53ea\u662f\u5904\u7406\u8282\u70b9\u7684\u6807\u8bc6",a.a.createElement("code",null,"fiber.flags"),"\u4e0d\u540c)."),a.a.createElement("li",null,"\u8c03\u7528\u6e32\u67d3\u5668, \u8f93\u51fa\u6700\u7ec8\u7ed3\u679c. (\u5728\u6b65\u9aa4 2: ",a.a.createElement("code",null,"commitMutationEffects"),"\u4e2d\u6267\u884c).")),a.a.createElement("p",null,"\u6240\u4ee5",a.a.createElement("code",null,"commitRootImpl"),"\u662f\u5904\u7406",a.a.createElement("code",null,"fiberRoot.finishedWork"),"\u8fd9\u68f5\u5373\u5c06\u88ab\u6e32\u67d3\u7684",a.a.createElement("code",null,"fiber"),"\u6811, \u7406\u8bba\u4e0a\u65e0\u9700\u5173\u5fc3\u8fd9\u68f5",a.a.createElement("code",null,"fiber"),"\u6811\u662f\u5982\u4f55\u4ea7\u751f\u7684(\u53ef\u4ee5\u662f",a.a.createElement("code",null,"\u9996\u6b21\u6784\u9020"),"\u4ea7\u751f, \u4e5f\u53ef\u4ee5\u662f",a.a.createElement("code",null,"\u5bf9\u6bd4\u66f4\u65b0"),"\u4ea7\u751f). \u4e3a\u4e86\u6e05\u6670\u7b80\u4fbf, \u5728\u4e0b\u6587\u7684\u6240\u6709\u56fe\u793a\u90fd\u4f7f\u7528",a.a.createElement("code",null,"\u521d\u6b21\u521b\u5efa\u7684fiber\u6811\u7ed3\u6784"),"\u6765\u8fdb\u884c\u6f14\u793a."),a.a.createElement("p",null,"\u8fd9 3 \u4e2a\u51fd\u6570\u5904\u7406\u7684\u5bf9\u8c61\u662f",a.a.createElement("code",null,"\u526f\u4f5c\u7528\u961f\u5217"),"\u548c",a.a.createElement("code",null,"DOM\u5bf9\u8c61"),"."),a.a.createElement("p",null,"\u6240\u4ee5\u65e0\u8bba",a.a.createElement("code",null,"fiber\u6811"),"\u7ed3\u6784\u6709\u591a\u4e48\u590d\u6742, \u5230\u4e86",a.a.createElement("code",null,"commitRoot"),"\u9636\u6bb5, \u5b9e\u9645\u8d77\u4f5c\u7528\u7684\u53ea\u6709 2 \u4e2a\u8282\u70b9:"),a.a.createElement("ul",null,a.a.createElement("li",null,a.a.createElement("code",null,"\u526f\u4f5c\u7528\u961f\u5217"),"\u6240\u5728\u8282\u70b9: \u6839\u8282\u70b9, \u5373",a.a.createElement("code",null,"HostRootFiber"),"\u8282\u70b9."),a.a.createElement("li",null,a.a.createElement("code",null,"DOM\u5bf9\u8c61"),"\u6240\u5728\u8282\u70b9: \u4ece\u4e0a\u81f3\u4e0b\u9996\u4e2a",a.a.createElement("code",null,"HostComponent"),"\u7c7b\u578b\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9, \u6b64\u8282\u70b9 \b",a.a.createElement("code",null,"fiber.stateNode"),"\u5b9e\u9645\u4e0a\u6307\u5411\u6700\u65b0\u7684 DOM \u6811.")),a.a.createElement("p",null,"\u4e0b\u56fe\u4e3a\u4e86\u6e05\u6670, \u7701\u7565\u4e86\u4e00\u4e9b\u65e0\u5173\u5f15\u7528, \u53ea\u7559\u4e0b",a.a.createElement("code",null,"commitRoot"),"\u9636\u6bb5\u5b9e\u9645\u4f1a\u7528\u5230\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9:"),a.a.createElement("p",null,a.a.createElement("img",{src:n("RaH4"),alt:""})),a.a.createElement("h4",{id:"commitbeforemutationeffects"},a.a.createElement(c["AnchorLink"],{to:"#commitbeforemutationeffects","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"commitBeforeMutationEffects"),a.a.createElement("p",null,"\u7b2c\u4e00\u9636\u6bb5: dom \u53d8\u66f4\u4e4b\u524d, \u5904\u7406\u526f\u4f5c\u7528\u961f\u5217\u4e2d\u5e26\u6709",a.a.createElement("code",null,"Snapshot"),",",a.a.createElement("code",null,"Passive"),"\u6807\u8bb0\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9."),a.a.createElement(o["a"],{code:"// ... \u7701\u7565\u90e8\u5206\u65e0\u5173\u4ee3\u7801\nfunction commitBeforeMutationEffects() {\n  while (nextEffect !== null) {\n    const current = nextEffect.alternate;\n    const flags = nextEffect.flags;\n    // \u5904\u7406`Snapshot`\u6807\u8bb0\n    if ((flags & Snapshot) !== NoFlags) {\n      commitBeforeMutationEffectOnFiber(current, nextEffect);\n    }\n    // \u5904\u7406`Passive`\u6807\u8bb0\n    if ((flags & Passive) !== NoFlags) {\n      // Passive\u6807\u8bb0\u53ea\u5728\u4f7f\u7528\u4e86hook, useEffect\u4f1a\u51fa\u73b0. \u6240\u4ee5\u6b64\u5904\u662f\u9488\u5bf9hook\u5bf9\u8c61\u7684\u5904\u7406\n      if (!rootDoesHavePassiveEffects) {\n        rootDoesHavePassiveEffects = true;\n        scheduleCallback(NormalSchedulerPriority, () => {\n          flushPassiveEffects();\n          return null;\n        });\n      }\n    }\n    nextEffect = nextEffect.nextEffect;\n  }\n}",lang:"js"}),a.a.createElement("p",null,"\u6ce8\u610f\uff1a",a.a.createElement("code",null,"commitBeforeMutationEffectOnFiber"),"\u5b9e\u9645\u4e0a\u5bf9\u5e94\u4e86",a.a.createElement("code",null,"commitBeforeMutationLifeCycles"),"\u51fd\u6570\uff0c\u5728\u5bfc\u5165\u65f6\u8fdb\u884c\u4e86\u91cd\u547d\u540d"),a.a.createElement("ol",null,a.a.createElement("li",null,"\u5904\u7406",a.a.createElement("code",null,"Snapshot"),"\u6807\u8bb0")),a.a.createElement(o["a"],{code:"function commitBeforeMutationLifeCycles(\n  current: Fiber | null,\n  finishedWork: Fiber,\n): void {\n  switch (finishedWork.tag) {\n    case FunctionComponent:\n    case ForwardRef:\n    case SimpleMemoComponent:\n    case Block: {\n      return;\n    }\n    case ClassComponent: {\n      if (finishedWork.flags & Snapshot) {\n        if (current !== null) {\n          const prevProps = current.memoizedProps;\n          const prevState = current.memoizedState;\n          const instance = finishedWork.stateNode;\n\n          const snapshot = instance.getSnapshotBeforeUpdate(\n            finishedWork.elementType === finishedWork.type\n              ? prevProps\n              : resolveDefaultProps(finishedWork.type, prevProps),\n            prevState,\n          );\n          instance.__reactInternalSnapshotBeforeUpdate = snapshot;\n        }\n      }\n      return;\n    }\n    case HostRoot: {\n      if (supportsMutation) {\n        if (finishedWork.flags & Snapshot) {\n          const root = finishedWork.stateNode;\n          clearContainer(root.containerInfo);\n        }\n      }\n      return;\n    }\n    case HostComponent:\n    case HostText:\n    case HostPortal:\n    case IncompleteClassComponent:\n      return;\n  }\n}",lang:"js"}),a.a.createElement("p",null,"\u4ece\u6e90\u7801\u4e2d\u53ef\u4ee5\u770b\u5230, \u4e0e",a.a.createElement("code",null,"Snapshot"),"\u6807\u8bb0\u76f8\u5173\u7684\u7c7b\u578b\u53ea\u6709",a.a.createElement("code",null,"ClassComponent"),"\u548c",a.a.createElement("code",null,"HostRoot"),"."),a.a.createElement("ul",null,a.a.createElement("li",null,"\u5bf9\u4e8e",a.a.createElement("code",null,"ClassComponent"),"\u7c7b\u578b\u8282\u70b9, \u8c03\u7528\u4e86",a.a.createElement("code",null,"instance.getSnapshotBeforeUpdate"),"\u751f\u547d\u5468\u671f\u51fd\u6570"),a.a.createElement("li",null,"\u5bf9\u4e8e",a.a.createElement("code",null,"HostRoot"),"\u7c7b\u578b\u8282\u70b9, \u8c03\u7528",a.a.createElement("code",null,"clearContainer"),"\u6e05\u7a7a\u4e86\u5bb9\u5668\u8282\u70b9(\u5373",a.a.createElement("code",null,"div#root"),"\u8fd9\u4e2a dom \u8282\u70b9).")),a.a.createElement("ol",{start:2},a.a.createElement("li",null,"\u5904\u7406",a.a.createElement("code",null,"Passive"),"\u6807\u8bb0")),a.a.createElement("p",null,a.a.createElement("code",null,"Passive"),"\u6807\u8bb0\u53ea\u4f1a\u5728\u4f7f\u7528\u4e86",a.a.createElement("code",null,"hook"),"\u5bf9\u8c61\u7684",a.a.createElement("code",null,"function"),"\u7c7b\u578b\u7684\u8282\u70b9\u4e0a\u5b58\u5728, \u540e\u7eed\u7684\u6267\u884c\u8fc7\u7a0b\u5728",a.a.createElement("code",null,"hook\u539f\u7406"),"\u7ae0\u8282\u4e2d\u8be6\u7ec6\u8bf4\u660e. \u6b64\u5904\u6211\u4eec\u9700\u8981\u4e86\u89e3\u5728",a.a.createElement("code",null,"commitRoot"),"\u7684\u7b2c\u4e00\u4e2a\u9636\u6bb5, \u4e3a\u4e86\u5904\u7406",a.a.createElement("code",null,"hook"),"\u5bf9\u8c61(\u5982",a.a.createElement("code",null,"useEffect"),"), \u901a\u8fc7",a.a.createElement("code",null,"scheduleCallback"),"\u5355\u72ec\u6ce8\u518c\u4e86\u4e00\u4e2a\u8c03\u5ea6\u4efb\u52a1",a.a.createElement("code",null,"task"),", \u7b49\u5f85\u8c03\u5ea6\u4e2d\u5fc3",a.a.createElement("code",null,"scheduler"),"\u5904\u7406."),a.a.createElement("p",null,"\u6ce8\u610f: \u901a\u8fc7\u8c03\u5ea6\u4e2d\u5fc3",a.a.createElement("code",null,"scheduler"),"\u8c03\u5ea6\u7684\u4efb\u52a1",a.a.createElement("code",null,"task"),"\u5747\u662f\u901a\u8fc7",a.a.createElement("code",null,"MessageChannel"),"\u89e6\u53d1, \u90fd\u662f\u5f02\u6b65\u6267\u884c(\u53ef\u53c2\u8003",a.a.createElement(c["Link"],{to:"./scheduler"},"React \u8c03\u5ea6\u539f\u7406(scheduler)"),")."),a.a.createElement("p",null,"\u5c0f\u6d4b\u8bd5:"),a.a.createElement(o["a"],{code:"// \u4ee5\u4e0b\u793a\u4f8b\u4ee3\u7801\u4e2d\u7684\u8f93\u51fa\u987a\u5e8f\u4e3a 1, 3, 4, 2\nfunction Test() {\n  console.log(1);\n  useEffect(() => {\n    console.log(2);\n  });\n  console.log(3);\n  Promise.resolve(() => {\n    console.log(4);\n  });\n  return <div>test</div>;\n}",lang:"js"}),a.a.createElement("h4",{id:"commitmutationeffects"},a.a.createElement(c["AnchorLink"],{to:"#commitmutationeffects","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"commitMutationEffects"),a.a.createElement("p",null,"\u7b2c\u4e8c\u9636\u6bb5: dom \u53d8\u66f4, \u754c\u9762\u5f97\u5230\u66f4\u65b0. \u5904\u7406\u526f\u4f5c\u7528\u961f\u5217\u4e2d\u5e26\u6709",a.a.createElement("code",null,"ContentReset"),", ",a.a.createElement("code",null,"Ref"),", ",a.a.createElement("code",null,"Placement"),", ",a.a.createElement("code",null,"Update"),", ",a.a.createElement("code",null,"Deletion"),", ",a.a.createElement("code",null,"Hydrating"),"\u6807\u8bb0\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9."),a.a.createElement(o["a"],{code:"// ...\u7701\u7565\u90e8\u5206\u65e0\u5173\u4ee3\u7801\nfunction commitMutationEffects(\n  root: FiberRoot,\n  renderPriorityLevel: ReactPriorityLevel,\n) {\n  // \u5904\u7406Ref\n  if (flags & Ref) {\n    const current = nextEffect.alternate;\n    if (current !== null) {\n      // \u5148\u6e05\u7a7aref, \u5728commitRoot\u7684\u7b2c\u4e09\u9636\u6bb5(dom\u53d8\u66f4\u540e), \u518d\u91cd\u65b0\u8d4b\u503c\n      commitDetachRef(current);\n    }\n  }\n  // \u5904\u7406DOM\u7a81\u53d8\n  while (nextEffect !== null) {\n    const flags = nextEffect.flags;\n    const primaryFlags = flags & (Placement | Update | Deletion | Hydrating);\n    switch (primaryFlags) {\n      case Placement: {\n        // \u65b0\u589e\u8282\u70b9\n        commitPlacement(nextEffect);\n        nextEffect.flags &= ~Placement; // \u6ce8\u610fPlacement\u6807\u8bb0\u4f1a\u88ab\u6e05\u9664\n        break;\n      }\n      case PlacementAndUpdate: {\n        // Placement\n        commitPlacement(nextEffect);\n        nextEffect.flags &= ~Placement;\n        // Update\n        const current = nextEffect.alternate;\n        commitWork(current, nextEffect);\n        break;\n      }\n      case Update: {\n        // \u66f4\u65b0\u8282\u70b9\n        const current = nextEffect.alternate;\n        commitWork(current, nextEffect);\n        break;\n      }\n      case Deletion: {\n        // \u5220\u9664\u8282\u70b9\n        commitDeletion(root, nextEffect, renderPriorityLevel);\n        break;\n      }\n    }\n    nextEffect = nextEffect.nextEffect;\n  }\n}",lang:"js"}),a.a.createElement("p",null,"\u5904\u7406 DOM \u7a81\u53d8:"),a.a.createElement("ol",null,a.a.createElement("li",null,a.a.createElement("code",null,"\u65b0\u589e"),": \u51fd\u6570\u8c03\u7528\u6808 ",a.a.createElement("code",null,"commitPlacement")," -> ",a.a.createElement("code",null,"insertOrAppendPlacementNode")," -> ",a.a.createElement("code",null,"appendChild")),a.a.createElement("li",null,a.a.createElement("code",null,"\u66f4\u65b0"),": \u51fd\u6570\u8c03\u7528\u6808 ",a.a.createElement("code",null,"commitWork")," -> ",a.a.createElement("code",null,"commitUpdate")),a.a.createElement("li",null,a.a.createElement("code",null,"\u5220\u9664"),": \u51fd\u6570\u8c03\u7528\u6808 ",a.a.createElement("code",null,"commitDeletion")," -> ",a.a.createElement("code",null,"removeChild"))),a.a.createElement("p",null,"\u6700\u7ec8\u4f1a\u8c03\u7528",a.a.createElement("code",null,"appendChild, commitUpdate, removeChild"),"\u8fd9\u4e9b",a.a.createElement("code",null,"react-dom"),"\u5305\u4e2d\u7684\u51fd\u6570. \u5b83\u4eec\u662f",a.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/README.md#practical-examples"},a.a.createElement("code",null,"HostConfig"),"\u534f\u8bae"),"(",a.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMHostConfig.js"},"\u6e90\u7801\u5728 ReactDOMHostConfig.js \u4e2d"),")\u4e2d\u89c4\u5b9a\u7684\u6807\u51c6\u51fd\u6570, \u5728\u6e32\u67d3\u5668",a.a.createElement("code",null,"react-dom"),"\u5305\u4e2d\u8fdb\u884c\u5b9e\u73b0. \u8fd9\u4e9b\u51fd\u6570\u5c31\u662f\u76f4\u63a5\u64cd\u4f5c DOM, \u6240\u4ee5\u6267\u884c\u4e4b\u540e, \u754c\u9762\u4e5f\u4f1a\u5f97\u5230\u66f4\u65b0."),a.a.createElement("p",null,"\u6ce8\u610f: ",a.a.createElement("code",null,"commitMutationEffects"),"\u6267\u884c\u4e4b\u540e, \u5728",a.a.createElement("code",null,"commitRootImpl"),"\u51fd\u6570\u4e2d\u5207\u6362\u5f53\u524d",a.a.createElement("code",null,"fiber"),"\u6811(",a.a.createElement("code",null,"root.current = finishedWork"),"),\u4fdd\u8bc1",a.a.createElement("code",null,"fiberRoot.current"),"\u6307\u5411\u4ee3\u8868\u5f53\u524d\u754c\u9762\u7684",a.a.createElement("code",null,"fiber\u6811"),"."),a.a.createElement("p",null,a.a.createElement("img",{src:n("H4Jk"),alt:""})),a.a.createElement("h4",{id:"commitlayouteffects"},a.a.createElement(c["AnchorLink"],{to:"#commitlayouteffects","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"commitLayoutEffects"),a.a.createElement("p",null,"\u7b2c\u4e09\u9636\u6bb5: dom \u53d8\u66f4\u540e, \u5904\u7406\u526f\u4f5c\u7528\u961f\u5217\u4e2d\u5e26\u6709",a.a.createElement("code",null,"Update, Callback, Ref"),"\u6807\u8bb0\u7684",a.a.createElement("code",null,"fiber"),"\u8282\u70b9."),a.a.createElement(o["a"],{code:"// ...\u7701\u7565\u90e8\u5206\u65e0\u5173\u4ee3\u7801\nfunction commitLayoutEffects(root: FiberRoot, committedLanes: Lanes) {\n  while (nextEffect !== null) {\n    const flags = nextEffect.flags;\n    // \u5904\u7406 Update\u548cCallback\u6807\u8bb0\n    if (flags & (Update | Callback)) {\n      const current = nextEffect.alternate;\n      commitLayoutEffectOnFiber(root, current, nextEffect, committedLanes);\n    }\n    if (flags & Ref) {\n      // \u91cd\u65b0\u8bbe\u7f6eref\n      commitAttachRef(nextEffect);\n    }\n    nextEffect = nextEffect.nextEffect;\n  }\n}",lang:"js"}),a.a.createElement("p",null,"\u6838\u5fc3\u903b\u8f91\u90fd\u5728",a.a.createElement("code",null,"commitLayoutEffectOnFiber->commitLifeCycles"),"\u51fd\u6570\u4e2d."),a.a.createElement(o["a"],{code:"// ...\u7701\u7565\u90e8\u5206\u65e0\u5173\u4ee3\u7801\nfunction commitLifeCycles(\n  finishedRoot: FiberRoot,\n  current: Fiber | null,\n  finishedWork: Fiber,\n  committedLanes: Lanes,\n): void {\n  switch (finishedWork.tag) {\n    case ClassComponent: {\n      const instance = finishedWork.stateNode;\n      if (finishedWork.flags & Update) {\n        if (current === null) {\n          // \u521d\u6b21\u6e32\u67d3: \u8c03\u7528 componentDidMount\n          instance.componentDidMount();\n        } else {\n          const prevProps =\n            finishedWork.elementType === finishedWork.type\n              ? current.memoizedProps\n              : resolveDefaultProps(finishedWork.type, current.memoizedProps);\n          const prevState = current.memoizedState;\n          // \u66f4\u65b0\u9636\u6bb5: \u8c03\u7528 componentDidUpdate\n          instance.componentDidUpdate(\n            prevProps,\n            prevState,\n            instance.__reactInternalSnapshotBeforeUpdate,\n          );\n        }\n      }\n      const updateQueue: UpdateQueue<\n        *,\n      > | null = (finishedWork.updateQueue: any);\n      if (updateQueue !== null) {\n        // \u5904\u7406update\u56de\u8c03\u51fd\u6570 \u5982: this.setState({}, callback)\n        commitUpdateQueue(finishedWork, updateQueue, instance);\n      }\n      return;\n    }\n    case HostComponent: {\n      const instance: Instance = finishedWork.stateNode;\n      if (current === null && finishedWork.flags & Update) {\n        const type = finishedWork.type;\n        const props = finishedWork.memoizedProps;\n        // \u8bbe\u7f6efocus\u7b49\u539f\u751f\u72b6\u6001\n        commitMount(instance, type, props, finishedWork);\n      }\n      return;\n    }\n  }\n}",lang:"js"}),a.a.createElement("p",null,"\u5728",a.a.createElement("code",null,"commitLifeCycles"),"\u51fd\u6570\u4e2d:"),a.a.createElement("ul",null,a.a.createElement("li",null,"\u5bf9\u4e8e",a.a.createElement("code",null,"ClassComponent"),"\u8282\u70b9, \u8c03\u7528\u751f\u547d\u5468\u671f\u51fd\u6570",a.a.createElement("code",null,"componentDidMount"),"\u6216",a.a.createElement("code",null,"componentDidUpdate"),", \u8c03\u7528",a.a.createElement("code",null,"update.callback"),"\u56de\u8c03\u51fd\u6570."),a.a.createElement("li",null,"\u5bf9\u4e8e",a.a.createElement("code",null,"HostComponent"),"\u8282\u70b9, \u5982\u6709",a.a.createElement("code",null,"Update"),"\u6807\u8bb0, \u9700\u8981\u8bbe\u7f6e\u4e00\u4e9b\u539f\u751f\u72b6\u6001(\u5982: ",a.a.createElement("code",null,"focus"),"\u7b49)")),a.a.createElement("h3",{id:"\u6e32\u67d3\u540e"},a.a.createElement(c["AnchorLink"],{to:"#\u6e32\u67d3\u540e","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"\u6e32\u67d3\u540e"),a.a.createElement("p",null,"\u6267\u884c\u5b8c\u4e0a\u8ff0\u6b65\u9aa4\u4e4b\u540e, \u672c\u6b21\u6e32\u67d3\u4efb\u52a1\u5c31\u5df2\u7ecf\u5b8c\u6210\u4e86. \u5728\u6e32\u67d3\u5b8c\u6210\u540e, \u9700\u8981\u505a\u4e00\u4e9b\u91cd\u7f6e\u548c\u6e05\u7406\u5de5\u4f5c:"),a.a.createElement("ol",null,a.a.createElement("li",null,a.a.createElement("p",null,"\u6e05\u9664\u526f\u4f5c\u7528\u961f\u5217"),a.a.createElement("ul",null,a.a.createElement("li",null,"\u7531\u4e8e\u526f\u4f5c\u7528\u961f\u5217\u662f\u4e00\u4e2a\u94fe\u8868, \u7531\u4e8e\u5355\u4e2a",a.a.createElement("code",null,"fiber"),"\u5bf9\u8c61\u7684\u5f15\u7528\u5173\u7cfb, \u65e0\u6cd5\u88ab",a.a.createElement("code",null,"gc\u56de\u6536"),"."),a.a.createElement("li",null,"\u5c06\u94fe\u8868\u5168\u90e8\u62c6\u5f00, \u5f53",a.a.createElement("code",null,"fiber"),"\u5bf9\u8c61\u4e0d\u518d\u4f7f\u7528\u7684\u65f6\u5019, \u53ef\u4ee5\u88ab",a.a.createElement("code",null,"gc\u56de\u6536"),".")))),a.a.createElement("p",null,a.a.createElement("img",{src:n("xGHk"),alt:""})),a.a.createElement("ol",{start:2},a.a.createElement("li",null,"\u68c0\u6d4b\u66f4\u65b0",a.a.createElement("ul",null,a.a.createElement("li",null,"\u5728\u6574\u4e2a\u6e32\u67d3\u8fc7\u7a0b\u4e2d, \u6709\u53ef\u80fd\u4ea7\u751f\u65b0\u7684",a.a.createElement("code",null,"update"),"(\u6bd4\u5982\u5728",a.a.createElement("code",null,"componentDidMount"),"\u51fd\u6570\u4e2d, \u518d\u6b21\u8c03\u7528",a.a.createElement("code",null,"setState()"),")."),a.a.createElement("li",null,"\u5982\u679c\u662f\u5e38\u89c4(\u5f02\u6b65)\u4efb\u52a1, \u4e0d\u7528\u7279\u6b8a\u5904\u7406, \u8c03\u7528",a.a.createElement("code",null,"ensureRootIsScheduled"),"\u786e\u4fdd\u4efb\u52a1\u5df2\u7ecf\u6ce8\u518c\u5230\u8c03\u5ea6\u4e2d\u5fc3\u5373\u53ef."),a.a.createElement("li",null,"\u5982\u679c\u662f\u540c\u6b65\u4efb\u52a1, \u5219\u4e3b\u52a8\u8c03\u7528",a.a.createElement("code",null,"flushSyncCallbackQueue"),"(\u65e0\u9700\u518d\u6b21\u7b49\u5f85 scheduler \u8c03\u5ea6), \u518d\u6b21\u8fdb\u5165 fiber \u6811\u6784\u9020\u5faa\u73af")))),a.a.createElement(o["a"],{code:"// \u6e05\u9664\u526f\u4f5c\u7528\u961f\u5217\nif (rootDoesHavePassiveEffects) {\n  // \u6709\u88ab\u52a8\u4f5c\u7528(\u4f7f\u7528useEffect), \u4fdd\u5b58\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf\n} else {\n  // \u5206\u89e3\u526f\u4f5c\u7528\u961f\u5217\u94fe\u8868, \u8f85\u52a9\u5783\u573e\u56de\u6536.\n  // \u5982\u679c\u6709\u88ab\u52a8\u4f5c\u7528(\u4f7f\u7528useEffect), \u4f1a\u628a\u5206\u89e3\u64cd\u4f5c\u653e\u5728flushPassiveEffects\u51fd\u6570\u4e2d\n  nextEffect = firstEffect;\n  while (nextEffect !== null) {\n    const nextNextEffect = nextEffect.nextEffect;\n    nextEffect.nextEffect = null;\n    if (nextEffect.flags & Deletion) {\n      detachFiberAfterEffects(nextEffect);\n    }\n    nextEffect = nextNextEffect;\n  }\n}\n// \u91cd\u7f6e\u4e00\u4e9b\u5168\u5c40\u53d8\u91cf(\u7701\u7565\u8fd9\u90e8\u5206\u4ee3\u7801)...\n// \u4e0b\u9762\u4ee3\u7801\u7528\u4e8e\u68c0\u6d4b\u662f\u5426\u6709\u65b0\u7684\u66f4\u65b0\u4efb\u52a1\n// \u6bd4\u5982\u5728componentDidMount\u51fd\u6570\u4e2d, \u518d\u6b21\u8c03\u7528setState()\n\n// 1. \u68c0\u6d4b\u5e38\u89c4(\u5f02\u6b65)\u4efb\u52a1, \u5982\u679c\u6709\u5219\u4f1a\u53d1\u8d77\u5f02\u6b65\u8c03\u5ea6(\u8c03\u5ea6\u4e2d\u5fc3`scheduler`\u53ea\u80fd\u5f02\u6b65\u8c03\u7528)\nensureRootIsScheduled(root, now());\n// 2. \u68c0\u6d4b\u540c\u6b65\u4efb\u52a1, \u5982\u679c\u6709\u5219\u4e3b\u52a8\u8c03\u7528flushSyncCallbackQueue(\u65e0\u9700\u518d\u6b21\u7b49\u5f85scheduler\u8c03\u5ea6), \u518d\u6b21\u8fdb\u5165fiber\u6811\u6784\u9020\u5faa\u73af\nflushSyncCallbackQueue();",lang:"js"}),a.a.createElement("h2",{id:"\u603b\u7ed3"},a.a.createElement(c["AnchorLink"],{to:"#\u603b\u7ed3","aria-hidden":"true",tabIndex:-1},a.a.createElement("span",{className:"icon icon-link"})),"\u603b\u7ed3"),a.a.createElement("p",null,"\u672c\u8282\u5206\u6790\u4e86",a.a.createElement("code",null,"fiber \u6811\u6e32\u67d3"),"\u7684\u5904\u7406\u8fc7\u7a0b, \u4ece\u5b8f\u89c2\u4e0a\u770b",a.a.createElement("code",null,"fiber \u6811\u6e32\u67d3"),"\u4f4d\u4e8e",a.a.createElement("code",null,"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"\u4e2d\u7684\u8f93\u51fa\u9636\u6bb5, \u662f\u6574\u4e2a",a.a.createElement("code",null,"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"\u7684\u94fe\u8def\u4e2d\u6700\u540e\u4e00\u73af(\u4ece\u8f93\u5165\u5230\u8f93\u51fa). \u672c\u8282\u6839\u636e\u6e90\u7801, \u5177\u4f53\u4ece",a.a.createElement("code",null,"\u6e32\u67d3\u524d, \u6e32\u67d3, \u6e32\u67d3\u540e"),"\u4e09\u4e2a\u65b9\u9762\u5206\u89e3\u4e86",a.a.createElement("code",null,"commitRootImpl"),"\u51fd\u6570. \u5176\u4e2d\u6700\u6838\u5fc3\u7684",a.a.createElement("code",null,"\u6e32\u67d3"),"\u903b\u8f91\u53c8\u5206\u4e3a\u4e86 3 \u4e2a\u51fd\u6570, \u8fd9 3 \u4e2a\u51fd\u6570\u5171\u540c\u5904\u7406\u4e86\u6709\u526f\u4f5c\u7528",a.a.createElement("code",null,"fiber"),"\u8282\u70b9, \u5e76\u901a\u8fc7\u6e32\u67d3\u5668",a.a.createElement("code",null,"react-dom"),"\u628a\u6700\u65b0\u7684 DOM \u5bf9\u8c61\u6e32\u67d3\u5230\u754c\u9762\u4e0a.")))}));t["default"]=e=>{var t=a.a.useContext(c["context"]),n=t.demos;return a.a.useEffect((()=>{var t;null!==e&&void 0!==e&&null!==(t=e.location)&&void 0!==t&&t.hash&&c["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),a.a.createElement(r,{demos:n})}},H4Jk:function(e,t,n){e.exports=n.p+"static/fiber-switch.e24a2f2d.png"},RaH4:function(e,t,n){e.exports=n.p+"static/fiber-noredundant.f4ab819d.png"},sD8s:function(e,t,n){e.exports=n.p+"static/fibertree-beforecommit.6a2f1987.png"},wOdG:function(e,t,n){e.exports=n.p+"static/reactfiberworkloop.59263ed5.png"},xGHk:function(e,t,n){e.exports=n.p+"static/clear-effectlist.9a7a18af.png"}}]);
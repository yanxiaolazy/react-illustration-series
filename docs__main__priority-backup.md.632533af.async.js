(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[25],{c6H6:function(e,n,t){"use strict";t.r(n);var a=t("q1tI"),l=t.n(a),r=t("dEAq"),c=t("H1Ra"),o=l.a.memo((e=>{e.demos;return l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"markdown"},l.a.createElement("h1",{id:"react-\u4e2d\u7684\u4f18\u5148\u7ea7\u7ba1\u7406"},l.a.createElement(r["AnchorLink"],{to:"#react-\u4e2d\u7684\u4f18\u5148\u7ea7\u7ba1\u7406","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"React \u4e2d\u7684\u4f18\u5148\u7ea7\u7ba1\u7406"),l.a.createElement("p",null,l.a.createElement("code",null,"React"),"\u662f\u4e00\u4e2a\u58f0\u660e\u5f0f, \u9ad8\u6548\u4e14\u7075\u6d3b\u7684\u7528\u4e8e\u6784\u5efa\u7528\u6237\u754c\u9762\u7684 JavaScript \u5e93. React \u56e2\u961f\u4e00\u76f4\u81f4\u529b\u4e8e\u5b9e\u73b0\u9ad8\u6548\u6e32\u67d3, \u5176\u4e2d\u6709 2 \u4e2a\u5341\u5206\u6709\u540d\u7684\u6f14\u8bb2:"),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement(r["Link"],{to:"http://conf2017.reactjs.org/speakers/lin"},"2017 \u5e74 Lin Clark \u7684\u6f14\u8bb2"),"\u4e2d\u4ecb\u7ecd\u4e86",l.a.createElement("code",null,"fiber"),"\u67b6\u6784\u548c",l.a.createElement("code",null,"\u53ef\u4e2d\u65ad\u6e32\u67d3"),"."),l.a.createElement("li",null,l.a.createElement(r["Link"],{to:"https://zh-hans.reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html"},"2018 \u5e74 Dan \u5728 JSConf \u51b0\u5c9b\u7684\u6f14\u8bb2"),"\u8fdb\u4e00\u6b65\u4ecb\u7ecd\u4e86\u65f6\u95f4\u5207\u7247(",l.a.createElement("code",null,"time slicing"),")\u548c\u5f02\u6b65\u6e32\u67d3(",l.a.createElement("code",null,"suspense"),")\u7b49\u7279\u6027.")),l.a.createElement("p",null,"\u6f14\u8bb2\u4e2d\u6240\u5c55\u793a\u7684",l.a.createElement("code",null,"\u53ef\u4e2d\u65ad\u6e32\u67d3"),",",l.a.createElement("code",null,"\u65f6\u95f4\u5207\u7247(time slicing)"),",",l.a.createElement("code",null,"\u5f02\u6b65\u6e32\u67d3(suspense)"),"\u7b49\u7279\u6027, \u5728\u6e90\u7801\u4e2d\u5f97\u4ee5\u5b9e\u73b0\u90fd\u4f9d\u8d56\u4e8e",l.a.createElement("code",null,"\u4f18\u5148\u7ea7\u7ba1\u7406"),"."),l.a.createElement("h2",{id:"\u9884\u5907\u77e5\u8bc6"},l.a.createElement(r["AnchorLink"],{to:"#\u9884\u5907\u77e5\u8bc6","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u9884\u5907\u77e5\u8bc6"),l.a.createElement("p",null,"\u5728\u6df1\u5165\u5206\u6790\u4e4b\u524d, \u518d\u6b21\u56de\u987e\u4e00\u4e0b(",l.a.createElement(r["Link"],{to:"./reconciler-workflow"},"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"):"),l.a.createElement("p",null,l.a.createElement("img",{src:t("wOdG"),alt:""})),l.a.createElement("p",null,"react \u5185\u90e8\u5bf9\u4e8e",l.a.createElement("code",null,"\u4f18\u5148\u7ea7"),"\u7684\u7ba1\u7406, \u6839\u636e\u5176\u6e90\u7801\u6240\u5728\u4e0d\u540c\u7684\u5305, \u53ef\u4ee5\u5206\u4e3a 2 \u79cd\u7c7b\u578b:"),l.a.createElement("ol",null,l.a.createElement("li",null,"\u6e32\u67d3\u4f18\u5148\u7ea7: \u4f4d\u4e8e",l.a.createElement("code",null,"react-reconciler"),"\u5305, \u4e5f\u5c31\u662f",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/pull/18796"},l.a.createElement("code",null,"Lane(\u8f66\u9053\u6a21\u578b)")),"."),l.a.createElement("li",null,"\u8c03\u5ea6\u4f18\u5148\u7ea7: \u4f4d\u4e8e",l.a.createElement("code",null,"scheduler"),"\u5305.")),l.a.createElement("h3",{id:"lane-\u8f66\u9053\u6a21\u578b"},l.a.createElement(r["AnchorLink"],{to:"#lane-\u8f66\u9053\u6a21\u578b","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"Lane (\u8f66\u9053\u6a21\u578b)"),l.a.createElement("blockquote",null,l.a.createElement("p",null,"\u82f1\u6587\u5355\u8bcd",l.a.createElement("code",null,"lane"),'\u7ffb\u8bd1\u6210\u4e2d\u6587\u8868\u793a"\u8f66\u9053, \u822a\u9053"\u7684\u610f\u601d, \u6240\u4ee5\u5f88\u591a\u6587\u7ae0\u90fd\u5c06',l.a.createElement("code",null,"Lanes"),"\u6a21\u578b\u79f0\u4e3a",l.a.createElement("code",null,"\u8f66\u9053\u6a21\u578b"))),l.a.createElement("p",null,l.a.createElement("code",null,"Lane"),"\u6a21\u578b\u7684\u6e90\u7801\u5728",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberLane.js"},"ReactFiberLane.js"),", \u6e90\u7801\u4e2d\u5927\u91cf\u4f7f\u7528\u4e86\u4f4d\u8fd0\u7b97(\u6709\u5173\u4f4d\u8fd0\u7b97\u7684\u8bb2\u89e3, \u53ef\u4ee5\u53c2\u8003",l.a.createElement(r["Link"],{to:"../algorithm/bitfield"},"React \u7b97\u6cd5\u4e4b\u4f4d\u8fd0\u7b97"),")."),l.a.createElement("p",null,"\u9996\u5148\u5f15\u5165\u4f5c\u8005\u5bf9",l.a.createElement("code",null,"Lane"),"\u7684\u89e3\u91ca(",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/pull/18796"},"\u76f8\u5e94\u7684 pr"),"), \u8fd9\u91cc\u7b80\u5355\u6982\u62ec\u5982\u4e0b:"),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"Lane"),"\u7c7b\u578b\u88ab\u5b9a\u4e49\u4e3a\u4e8c\u8fdb\u5236\u53d8\u91cf, \u5229\u7528\u4e86\u4f4d\u63a9\u7801\u7684\u7279\u6027, \u5728\u9891\u7e41\u7684\u65f6\u5019\u5360\u7528\u5185\u5b58\u5c11, \u8ba1\u7b97\u901f\u5ea6\u5feb."),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"Lane"),"\u548c",l.a.createElement("code",null,"Lanes"),"\u5c31\u662f\u5355\u6570\u548c\u590d\u6570\u7684\u5173\u7cfb, \u4ee3\u8868\u5355\u4e2a\u4efb\u52a1\u7684\u5b9a\u4e49\u4e3a",l.a.createElement("code",null,"Lane"),", \u4ee3\u8868\u591a\u4e2a\u4efb\u52a1\u7684\u5b9a\u4e49\u4e3a",l.a.createElement("code",null,"Lanes")))),l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"Lane"),"\u662f\u5bf9\u4e8e",l.a.createElement("code",null,"expirationTime"),"\u7684\u91cd\u6784, \u4ee5\u524d\u4f7f\u7528",l.a.createElement("code",null,"expirationTime"),"\u8868\u793a\u7684\u5b57\u6bb5, \u90fd\u6539\u4e3a\u4e86",l.a.createElement("code",null,"lane")),l.a.createElement(c["a"],{code:"renderExpirationtime -> renderLanes\n  update.expirationTime -> update.lane\n  fiber.expirationTime -> fiber.lanes\n  fiber.childExpirationTime -> fiber.childLanes\n  root.firstPendingTime and root.lastPendingTime -> fiber.pendingLanes",lang:"js"})),l.a.createElement("li",null,l.a.createElement("p",null,"\u4f7f\u7528",l.a.createElement("code",null,"Lanes"),"\u6a21\u578b\u76f8\u6bd4",l.a.createElement("code",null,"expirationTime"),"\u6a21\u578b\u7684\u4f18\u52bf:"),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"Lanes"),"\u628a\u4efb\u52a1\u4f18\u5148\u7ea7\u4ece\u6279\u91cf\u4efb\u52a1\u4e2d\u5206\u79bb\u51fa\u6765, \u53ef\u4ee5\u66f4\u65b9\u4fbf\u7684\u5224\u65ad\u5355\u4e2a\u4efb\u52a1\u4e0e\u6279\u91cf\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\u662f\u5426\u91cd\u53e0."),l.a.createElement(c["a"],{code:"// \u5224\u65ad: \u5355task\u4e0ebatchTask\u7684\u4f18\u5148\u7ea7\u662f\u5426\u91cd\u53e0\n//1. \u901a\u8fc7expirationTime\u5224\u65ad\nconst isTaskIncludedInBatch = priorityOfTask >= priorityOfBatch;\n//2. \u901a\u8fc7Lanes\u5224\u65ad\nconst isTaskIncludedInBatch = (task & batchOfTasks) !== 0;\n\n// \u5f53\u540c\u65f6\u5904\u7406\u4e00\u7ec4\u4efb\u52a1, \u8be5\u7ec4\u5185\u6709\u591a\u4e2a\u4efb\u52a1, \u4e14\u6bcf\u4e2a\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\u4e0d\u4e00\u81f4\n// 1. \u5982\u679c\u901a\u8fc7expirationTime\u5224\u65ad. \u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u8303\u56f4(\u5728Lane\u91cd\u6784\u4e4b\u524d, \u6e90\u7801\u4e2d\u5c31\u662f\u8fd9\u6837\u6bd4\u8f83\u7684)\nconst isTaskIncludedInBatch =\n  taskPriority <= highestPriorityInRange &&\n  taskPriority >= lowestPriorityInRange;\n//2. \u901a\u8fc7Lanes\u5224\u65ad\nconst isTaskIncludedInBatch = (task & batchOfTasks) !== 0;",lang:"js"})),l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"Lanes"),"\u4f7f\u7528\u5355\u4e2a 32 \u4f4d\u4e8c\u8fdb\u5236\u53d8\u91cf\u5373\u53ef\u4ee3\u8868\u591a\u4e2a\u4e0d\u540c\u7684\u4efb\u52a1, \u4e5f\u5c31\u662f\u8bf4\u4e00\u4e2a\u53d8\u91cf\u5373\u53ef\u4ee3\u8868\u4e00\u4e2a\u7ec4(",l.a.createElement("code",null,"group"),"), \u5982\u679c\u8981\u5728\u4e00\u4e2a group \u4e2d\u5206\u79bb\u51fa\u5355\u4e2a task, \u975e\u5e38\u5bb9\u6613."),l.a.createElement("blockquote",null,l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"expirationTime"),"\u6a21\u578b\u8bbe\u8ba1\u4e4b\u521d, react \u4f53\u7cfb\u4e2d\u8fd8\u6ca1\u6709",l.a.createElement(r["Link"],{to:"https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html"},"Suspense \u5f02\u6b65\u6e32\u67d3"),"\u7684\u6982\u5ff5. \u73b0\u5728\u6709\u5982\u4e0b\u573a\u666f: \u6709 3 \u4e2a\u4efb\u52a1, \u5176\u4f18\u5148\u7ea7 ",l.a.createElement("code",null,"A > B > C"),", \u6b63\u5e38\u6765\u8bb2\u53ea\u9700\u8981\u6309\u7167\u4f18\u5148\u7ea7\u987a\u5e8f\u6267\u884c\u5c31\u53ef\u4ee5\u4e86. \u4f46\u662f\u73b0\u5728\u60c5\u51b5\u53d8\u4e86: A \u548c C \u4efb\u52a1\u662f",l.a.createElement("code",null,"CPU\u5bc6\u96c6\u578b"),", \u800c B \u662f",l.a.createElement("code",null,"IO\u5bc6\u96c6\u578b"),"(Suspense \u4f1a\u8c03\u7528\u8fdc\u7a0b api, \u7b97\u662f IO \u4efb\u52a1), \u5373 ",l.a.createElement("code",null,"A(cup) > B(IO) > C(cpu)"),". \u6b64\u65f6\u7684\u9700\u6c42\u9700\u8981\u5c06\u4efb\u52a1",l.a.createElement("code",null,"B"),"\u4ece group \u4e2d\u5206\u79bb\u51fa\u6765, \u5148\u5904\u7406 cpu \u4efb\u52a1",l.a.createElement("code",null,"A\u548cC"),".")),l.a.createElement(c["a"],{code:"// \u4ecegroup\u4e2d\u5220\u9664\u6216\u589e\u52a0task\n\n//1. \u901a\u8fc7expirationTime\u5b9e\u73b0\n// 0) \u7ef4\u62a4\u4e00\u4e2a\u94fe\u8868, \u6309\u7167\u5355\u4e2atask\u7684\u4f18\u5148\u7ea7\u987a\u5e8f\u8fdb\u884c\u63d2\u5165\n// 1) \u5220\u9664\u5355\u4e2atask(\u4ece\u94fe\u8868\u4e2d\u5220\u9664\u4e00\u4e2a\u5143\u7d20)\ntask.prev.next = task.next;\n// 2) \u589e\u52a0\u5355\u4e2atask(\u9700\u8981\u5bf9\u6bd4\u5f53\u524dtask\u7684\u4f18\u5148\u7ea7, \u63d2\u5165\u5230\u94fe\u8868\u6b63\u786e\u7684\u4f4d\u7f6e\u4e0a)\nlet current = queue;\nwhile (task.expirationTime >= current.expirationTime) {\n  current = current.next;\n}\ntask.next = current.next;\ncurrent.next = task;\n// 3) \u6bd4\u8f83task\u662f\u5426\u5728group\u4e2d\nconst isTaskIncludedInBatch =\n  taskPriority <= highestPriorityInRange &&\n  taskPriority >= lowestPriorityInRange;",lang:"js"}),l.a.createElement(c["a"],{code:"// 2. \u901a\u8fc7Lanes\u5b9e\u73b0\n// 1) \u5220\u9664\u5355\u4e2atask\n  batchOfTasks &= ~task\n// 2) \u589e\u52a0\u5355\u4e2atask\n  batchOfTasks |= task\n// 3) \u6bd4\u8f83task\u662f\u5426\u5728group\u4e2d\n const isTaskIncludedInBatch = (task & batchOfTasks) !== 0;",lang:"unknown"}),l.a.createElement(c["a"],{code:"\u901a\u8fc7\u4e0a\u8ff0\u4f2a\u4ee3\u7801, \u53ef\u4ee5\u770b\u5230`Lanes`\u7684\u4f18\u8d8a\u6027, \u8fd0\u7528\u8d77\u6765\u4ee3\u7801\u91cf\u5c11, \u7b80\u6d01\u9ad8\u6548.",lang:"unknown"})))),l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"Lanes"),"\u662f\u4e00\u4e2a\u4e0d\u900f\u660e\u7684\u7c7b\u578b, \u53ea\u80fd\u5728",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberLane.js"},l.a.createElement("code",null,"ReactFiberLane.js")),"\u8fd9\u4e2a\u6a21\u5757\u4e2d\u7ef4\u62a4. \u5982\u679c\u8981\u5728\u5176\u4ed6\u6587\u4ef6\u4e2d\u4f7f\u7528, \u53ea\u80fd\u901a\u8fc7",l.a.createElement("code",null,"ReactFiberLane.js"),"\u4e2d\u63d0\u4f9b\u7684\u5de5\u5177\u51fd\u6570\u6765\u4f7f\u7528."))),l.a.createElement("p",null,"\u5206\u6790\u8f66\u9053\u6a21\u578b\u7684\u6e90\u7801(",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberLane.js"},l.a.createElement("code",null,"ReactFiberLane.js")),"\u4e2d), \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u7ed3\u8bba:"),l.a.createElement("ol",null,l.a.createElement("li",null,"\u53ef\u4ee5\u4f7f\u7528\u7684\u6bd4\u7279\u4f4d\u4e00\u5171\u6709 31 \u4f4d(\u4e3a\u4ec0\u4e48? \u53ef\u4ee5\u53c2\u8003",l.a.createElement(r["Link"],{to:"../algorithm/bitfield"},"React \u7b97\u6cd5\u4e4b\u4f4d\u8fd0\u7b97"),"\u4e2d\u7684\u8bf4\u660e)."),l.a.createElement("li",null,"\u5171\u5b9a\u4e49\u4e86",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberLane.js#L74-L103"},"18 \u79cd\u8f66\u9053(",l.a.createElement("code",null,"Lane/Lanes"),")\u53d8\u91cf"),", \u6bcf\u4e00\u4e2a\u53d8\u91cf\u5360\u6709 1 \u4e2a\u6216\u591a\u4e2a\u6bd4\u7279\u4f4d, \u5206\u522b\u5b9a\u4e49\u4e3a",l.a.createElement("code",null,"Lane"),"\u548c",l.a.createElement("code",null,"Lanes"),"\u7c7b\u578b."),l.a.createElement("li",null,"\u6bcf\u4e00\u79cd\u8f66\u9053(",l.a.createElement("code",null,"Lane/Lanes"),")\u90fd\u6709\u5bf9\u5e94\u7684\u4f18\u5148\u7ea7, \u6240\u4ee5\u6e90\u7801\u4e2d\u5b9a\u4e49\u4e86 18 \u79cd\u4f18\u5148\u7ea7(",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberLane.js#L12-L30"},"LanePriority"),")."),l.a.createElement("li",null,"\u5360\u6709\u4f4e\u4f4d\u6bd4\u7279\u4f4d\u7684",l.a.createElement("code",null,"Lane"),"\u53d8\u91cf\u5bf9\u5e94\u7684\u4f18\u5148\u7ea7\u8d8a\u9ad8",l.a.createElement("ul",null,l.a.createElement("li",null,"\u6700\u9ad8\u4f18\u5148\u7ea7\u4e3a",l.a.createElement("code",null,"SyncLanePriority"),"\u5bf9\u5e94\u7684\u8f66\u9053\u4e3a",l.a.createElement("code",null,"SyncLane = 0b0000000000000000000000000000001"),"."),l.a.createElement("li",null,"\u6700\u9ad8\u4f18\u5148\u7ea7\u4e3a",l.a.createElement("code",null,"OffscreenLanePriority"),"\u5bf9\u5e94\u7684\u8f66\u9053\u4e3a",l.a.createElement("code",null,"OffscreenLane = 0b1000000000000000000000000000000"),".")))),l.a.createElement("h2",{id:"\u4f18\u5148\u7ea7\u4f7f\u7528"},l.a.createElement(r["AnchorLink"],{to:"#\u4f18\u5148\u7ea7\u4f7f\u7528","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u4f18\u5148\u7ea7\u4f7f\u7528"),l.a.createElement("p",null,"\u73b0\u5728\u6b63\u5f0f\u8fdb\u5165\u6b63\u9898, \u628a",l.a.createElement("code",null,"\u4f18\u5148\u7ea7"),"\u673a\u5236\u5bf9\u5e94\u5230",l.a.createElement("code",null,"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"\u4e2d, \u90a3\u4e48\u5b83\u521b\u5efa\u4e8e\u7b2c\u4e00\u6b65(",l.a.createElement("code",null,"\u8f93\u5165"),"), \u8d2f\u7a7f\u4e8e\u6574\u4e2a\u8f93\u5165\u5230\u8f93\u51fa\u7684\u8fc7\u7a0b. \u540e\u6587\u5c06\u4ee5",l.a.createElement("code",null,"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"\u7684 4 \u4e2a\u9636\u6bb5\u4e3a\u65f6\u95f4\u7ebf, \u9010\u4e00\u5206\u6790\u6bcf\u4e00\u4e2a\u6b65\u9aa4\u4e2d\u5173\u4e8e",l.a.createElement("code",null,"\u4f18\u5148\u7ea7"),"\u7684\u8fd0\u7528\u60c5\u51b5."),l.a.createElement("h3",{id:"\u8f93\u5165\u9636\u6bb5"},l.a.createElement(r["AnchorLink"],{to:"#\u8f93\u5165\u9636\u6bb5","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u8f93\u5165\u9636\u6bb5"),l.a.createElement("p",null,"\u901a\u8fc7",l.a.createElement(r["Link"],{to:"./bootstrap"},"\u542f\u52a8\u8fc7\u7a0b"),"\u4e00\u6587\u7684\u89e3\u8bfb, \u6211\u4eec\u77e5\u9053",l.a.createElement("code",null,"react"),"\u5e94\u7528\u521d\u59cb\u5316\u4e4b\u540e, \u4f1a\u7ecf\u8fc7",l.a.createElement("code",null,"updateContainer"),"\u51fd\u6570, \u6700\u540e\u8fdb\u5165",l.a.createElement("code",null,"scheduleUpdateOnFiber"),"\u51fd\u6570."),l.a.createElement("p",null,"\u6ce8\u610f",l.a.createElement("code",null,"scheduleUpdateOnFiber(fiber: Fiber,lane: Lane,eventTime: number)"),"\u51fd\u6570\u7b7e\u540d\u4e2d\u7684\u7b2c 2 \u4e2a\u53c2\u6570",l.a.createElement("code",null,"lane: Lane"),"\u5c31\u662f\u8d2f\u7a7f\u5168\u5c40\u7684\u4f18\u5148\u7ea7, \u5b83\u662f",l.a.createElement("code",null,"Lane"),"\u7c7b\u578b, \u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u4e8c\u7ea7\u5236\u53d8\u91cf."),l.a.createElement("p",null,"\u518d\u5f80\u524d\u63a8\u4e00\u6b65, ",l.a.createElement("code",null,"lane"),"\u5b9e\u9645\u4e0a\u662f\u5728",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberReconciler.old.js#L250-L321"},l.a.createElement("code",null,"updateContainer")),"\u51fd\u6570\u4e2d\u9996\u6b21\u521b\u5efa(\u4f18\u5148\u7ea7\u7684\u6e90\u5934\u6240\u5728)."),l.a.createElement(c["a"],{code:"// ... \u7701\u7565\u90e8\u5206\u65e0\u5173\u4ee3\u7801\nexport function updateContainer(\n  element: ReactNodeList,\n  container: OpaqueRoot,\n  parentComponent: ?React$Component<any, any>,\n  callback: ?Function,\n): Lane {\n  const current = container.current;\n  // 1. \u83b7\u53d6\u5f53\u524d\u65f6\u95f4\u6233\n  const eventTime = requestEventTime();\n  // 2. \u521b\u5efa\u4e00\u4e2a\u4f18\u5148\u7ea7\u53d8\u91cf(\u8f66\u9053\u6a21\u578b)\n  const lane = requestUpdateLane(current);\n\n  // 3. \u6839\u636e\u8f66\u9053\u4f18\u5148\u7ea7, \u521b\u5efaupdate\u5bf9\u8c61, \u5e76\u52a0\u5165fiber.updateQueue.pending\u961f\u5217\n  const update = createUpdate(eventTime, lane);\n  update.payload = { element };\n  enqueueUpdate(current, update);\n\n  // 4. \u6b63\u5f0f\u8fdb\u5165`\u8f93\u5165`\u73af\u8282\n  scheduleUpdateOnFiber(current, lane, eventTime);\n\n  return lane;\n}",lang:"js"}),l.a.createElement("p",null,"\u9996\u5148\u5206\u6790",l.a.createElement("code",null,"requestEventTime()"),"\u51fd\u6570, \u987a\u7740\u8c03\u7528\u6808\u4f9d\u6b21\u8ddf\u8e2a, \u6700\u540e\u8c03\u7528\u4e86",l.a.createElement("code",null,"scheduler"),"\u5305\u4e2d\u7684",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L19-L25"},l.a.createElement("code",null,"getCurrentTime()")),", \u8fd4\u56de\u4e86\u4ece",l.a.createElement("code",null,"react"),"\u5e94\u7528\u5f00\u59cb\u8fd0\u884c, \u5230\u672c\u6b21\u8c03\u7528\u7ecf\u8fc7\u7684\u7edd\u5bf9\u65f6\u95f4(\u5373",l.a.createElement("code",null,"performance.now()"),")"),l.a.createElement("p",null,"\u7136\u540e\u8ddf\u8e2a",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L392-L493"},l.a.createElement("code",null,"requestUpdateLane"),"\u51fd\u6570"),":"),l.a.createElement(c["a"],{code:"//... \u7701\u7565\u90e8\u5206\u4ee3\u7801\nexport function requestUpdateLane(fiber: Fiber): Lane {\n  // Special cases\n  const mode = fiber.mode;\n  if ((mode & BlockingMode) === NoMode) {\n    // Legacy \u6a21\u5f0f\n    return (SyncLane: Lane);\n  } else if ((mode & ConcurrentMode) === NoMode) {\n    // Blocking \u6a21\u5f0f\n    return getCurrentPriorityLevel() === ImmediateSchedulerPriority\n      ? (SyncLane: Lane)\n      : (SyncBatchedLane: Lane);\n  }\n  // Concurrent \u6a21\u5f0f\n  if (currentEventWipLanes === NoLanes) {\n    currentEventWipLanes = workInProgressRootIncludedLanes;\n  }\n  const schedulerPriority = getCurrentPriorityLevel();\n  let lane;\n  const schedulerLanePriority = schedulerPriorityToLanePriority(\n    schedulerPriority,\n  );\n  lane = findUpdateLane(schedulerLanePriority, currentEventWipLanes);\n  return lane;\n}",lang:"js"}),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"requestUpdateLane"),"\u4e2d\u4f1a\u6839\u636e\u4e0d\u540c\u7684\u6a21\u5f0f, \u8fd4\u56de\u4e0d\u540c\u7684\u4f18\u5148\u7ea7, \u9ed8\u8ba4\u60c5\u51b5\u5982\u4e0b:"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"Legacy"),"\u6a21\u5f0f\u4e3a",l.a.createElement("code",null,"SyncLane")),l.a.createElement("li",null,l.a.createElement("code",null,"Blocking"),"\u6a21\u5f0f\u4e3a",l.a.createElement("code",null,"SyncBatchedLane")),l.a.createElement("li",null,l.a.createElement("code",null,"Concurrent"),"\u6a21\u5f0f\u4e3a",l.a.createElement("code",null,"DefaultLanes"))),l.a.createElement("p",null,"\u56de\u5230",l.a.createElement("code",null,"updateContainer"),"\u51fd\u6570, \u63a5\u4e0b\u6765\u4f7f\u7528\u4e86",l.a.createElement("code",null,"requestUpdateLane"),"\u8fd4\u56de\u7684\u4f18\u5148\u7ea7, \u521b\u5efa",l.a.createElement("code",null,"update"),"\u5bf9\u8c61, \u5e76\u6dfb\u52a0\u5230",l.a.createElement("code",null,"updateQueue"),"\u961f\u5217\u4e2d."),l.a.createElement("p",null,"\u6b64\u5904\u53ef\u4ee5\u56de\u987e",l.a.createElement(r["AnchorLink"],{to:"./object-structure#Update"},"React \u5e94\u7528\u4e2d\u7684\u9ad8\u9891\u5bf9\u8c61"),"\u7ae0\u8282\u4e2d\u5df2\u7ecf\u4ecb\u7ecd\u8fc7",l.a.createElement("code",null,"Update"),"\u4e0e",l.a.createElement("code",null,"UpdateQueue"),"\u5bf9\u8c61\u4ee5\u53ca\u5b83\u4eec\u7684\u6570\u636e\u7ed3\u6784. \u9700\u8981\u6ce8\u610f,",l.a.createElement("code",null,"update.payload"),"\u6307\u5411\u6700\u7ec8 DOM \u6811\u5c06\u8981\u6302\u8f7d\u7684\u8282\u70b9(",l.a.createElement("code",null,"div#root"),")."),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"updateContainer"),"\u51fd\u6570\u7684\u6700\u540e, \u8c03\u7528\u4e86",l.a.createElement("code",null,"scheduleUpdateOnFiber(current, lane, eventTime)"),"\u8fdb\u5165\u5230",l.a.createElement("code",null,"\u8f93\u5165"),"\u9636\u6bb5(",l.a.createElement(r["AnchorLink"],{to:"./reconciler-workflow#%E8%BE%93%E5%85%A5"},"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),")\u7684\u5fc5\u7ecf\u51fd\u6570. \u7531\u4e8e\u672c\u8282\u7684\u4e3b\u9898\u662f",l.a.createElement("code",null,"\u4f18\u5148\u7ea7\u7ba1\u7406"),", \u6240\u4ee5\u6211\u4eec\u91cd\u70b9\u8ddf\u8e2a",l.a.createElement("code",null,"lane \u548c eventTime"),"\u8fd9 2 \u4e2a\u53c2\u6570\u7684\u7528\u9014."),l.a.createElement(c["a"],{code:"// ... \u7701\u7565\u90e8\u5206\u65e0\u5173\u4ee3\u7801\nexport function scheduleUpdateOnFiber(\n  fiber: Fiber,\n  lane: Lane,\n  eventTime: number,\n) {\n  const root = markUpdateLaneFromFiberToRoot(fiber, lane);\n  if (lane === SyncLane) {\n    // Legacy \u6a21\u5f0f\u4e0b lane === SyncLane\u624d\u6210\u7acb\n    if (\n      (executionContext & LegacyUnbatchedContext) !== NoContext &&\n      (executionContext & (RenderContext | CommitContext)) === NoContext\n    ) {\n      // \u76f4\u63a5\u8fdb\u884c`fiber\u6784\u9020`\n      performSyncWorkOnRoot(root);\n    } else {\n      // \u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1, \u7ecf\u8fc7`Scheduler`\u5305\u7684\u8c03\u5ea6, \u95f4\u63a5\u8fdb\u884c`fiber\u6784\u9020`\n      ensureRootIsScheduled(root, eventTime);\n    }\n  } else {\n    // Blocking \u548c Concurrent\u6a21\u5f0f\n    ensureRootIsScheduled(root, eventTime);\n  }\n}",lang:"js"}),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"scheduleUpdateOnFiber"),"\u7684\u4e3b\u5e72\u903b\u8f91\u4e2d, \u53ea\u6709",l.a.createElement("code",null,"Legacy"),"\u6a21\u5f0f\u4e0b",l.a.createElement("code",null,"lane === SyncLane"),"\u624d\u6210\u7acb, \u624d\u4f1a\u76f4\u63a5\u8fdb\u5165",l.a.createElement("code",null,"performSyncWorkOnRoot"),", \u5426\u5219\u5fc5\u7136\u8c03\u7528",l.a.createElement("code",null,"ensureRootIsScheduled"),"\u8fdb\u5165\u5230",l.a.createElement("code",null,"\u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1"),". \u6ce8\u610f",l.a.createElement("code",null,"eventTime"),"\u88ab\u4f20\u5165\u4e86",l.a.createElement("code",null,"ensureRootIsScheduled"),"."),l.a.createElement("p",null,"\u6574\u7406\u51fa",l.a.createElement("code",null,"\u8f93\u5165\u9636\u6bb5"),"\u4f18\u5148\u7ea7\u76f8\u5173\u7684\u903b\u8f91:"),l.a.createElement("ol",null,l.a.createElement("li",null,"\u521b\u5efa\u4e00\u4e2a\u4f18\u5148\u7ea7\u53d8\u91cf",l.a.createElement("code",null,"lane")),l.a.createElement("li",null,"\u6839\u636e\u8f66\u9053\u4f18\u5148\u7ea7",l.a.createElement("code",null,"lane"),", \u521b\u5efa",l.a.createElement("code",null,"update"),"\u5bf9\u8c61, \u5e76\u52a0\u5165",l.a.createElement("code",null,"fiber.updateQueue.pending"),"\u961f\u5217")),l.a.createElement("h3",{id:"\u8c03\u5ea6\u9636\u6bb5"},l.a.createElement(r["AnchorLink"],{to:"#\u8c03\u5ea6\u9636\u6bb5","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u8c03\u5ea6\u9636\u6bb5"),l.a.createElement("p",null,"\u903b\u8f91\u6765\u5230\u4e86",l.a.createElement("code",null,"ensureRootIsScheduled"),"\u4e2d(",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L674-L736"},"\u6e90\u7801\u5730\u5740"),"), \u8fd9\u4e2a\u51fd\u6570\u4e32\u8054\u4e86",l.a.createElement("code",null,"react-reconciler"),"\u548c",l.a.createElement("code",null,"scheduler"),"2 \u5305, \u5341\u5206\u91cd\u8981:"),l.a.createElement(c["a"],{code:"// \u672c\u51fd\u6570\u6bcf\u6b21\u66f4\u65b0\u548c\u51fa\u8c03\u5ea6\u4efb\u52a1\u7684\u65f6\u5019\u8fdb\u884c\u8c03\u7528\nfunction ensureRootIsScheduled(root: FiberRoot, currentTime: number) {\n  // 1.  \u524d\u534a\u90e8\u5206: \u5224\u65ad\u662f\u5426\u9700\u8981\u6ce8\u518c\u65b0\u7684\u8c03\u5ea6\n  const existingCallbackNode = root.callbackNode;\n  // 1.1 \u68c0\u67e5starve, \u5c06\u5df2\u8fc7\u671f\u7684\u8f66\u9053(lane), \u6dfb\u52a0\u5230root.expiredLanes\u4e2d\n  markStarvedLanesAsExpired(root, currentTime);\n  // 1.2 \u83b7\u53d6\u5f53\u524d\u6700\u9700\u8981\u88ab\u8c03\u5ea6\u7684\u8f66\u9053(Lanes)\n  const nextLanes = getNextLanes(\n    root,\n    root === workInProgressRoot ? workInProgressRootRenderLanes : NoLanes,\n  );\n  // 1.3 \u83b7\u53d6\u9700\u8981\u8c03\u5ea6\u7684\u8f66\u9053\u7684\u4f18\u5148\u7ea7\u7b49\u7ea7\n  const newCallbackPriority = returnNextLanesPriority();\n  // 1.4 \u5982\u679c\u6ca1\u6709\u4efb\u4f55\u8f66\u9053\u9700\u8981\u8c03\u5ea6, \u5219\u9000\u51fa\u8c03\u5ea6\n  if (nextLanes === NoLanes) {\n    if (existingCallbackNode !== null) {\n      // \u53d6\u6d88\u5df2\u7ecf\u8fdb\u5165\u8c03\u5ea6\u7684\u4efb\u52a1\n      cancelCallback(existingCallbackNode);\n      root.callbackNode = null;\n      root.callbackPriority = NoLanePriority;\n    }\n    return;\n  }\n\n  // 1.5 \u5982\u679c\u5df2\u7ecf\u6709\u8c03\u5ea6\u4efb\u52a1\u4e86, \u5219\u6bd4\u8f83old\u4efb\u52a1\u4e0enew\u4efb\u52a1\u7684\u4f18\u5148\u7ea7\u7b49\u7ea7\n  if (existingCallbackNode !== null) {\n    const existingCallbackPriority = root.callbackPriority;\n    if (existingCallbackPriority === newCallbackPriority) {\n      // 1.5.1 \u4f18\u5148\u7ea7\u76f8\u540c, \u8868\u793a\u53ef\u4ee5\u590d\u7528old\u8c03\u5ea6\u4efb\u52a1, \u9000\u51fa\u5faa\u73af\n      return;\n    }\n    // 1.5.2 \u4f18\u5148\u7ea7\u4e0d\u540c, \u5219\u53d6\u6d88old\u8c03\u5ea6\u4efb\u52a1\n    cancelCallback(existingCallbackNode);\n  }\n\n  // 2. \u540e\u534a\u90e8\u5206: \u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1\n  let newCallbackNode;\n  // 2.1 \u6ce8\u518ctask\u5e76\u8bbe\u7f6e\u56de\u8c03\u51fd\u6570\n  if (newCallbackPriority === SyncLanePriority) {\n    // legacy \u6a21\u5f0f\n    newCallbackNode = scheduleSyncCallback(\n      performSyncWorkOnRoot.bind(null, root),\n    );\n  } else if (newCallbackPriority === SyncBatchedLanePriority) {\n    // blocking \u6a21\u5f0f\n    newCallbackNode = scheduleCallback(\n      ImmediateSchedulerPriority,\n      performSyncWorkOnRoot.bind(null, root),\n    );\n  } else {\n    // concurrent \u6a21\u5f0f\n    const schedulerPriorityLevel = lanePriorityToSchedulerPriority(\n      newCallbackPriority,\n    );\n    newCallbackNode = scheduleCallback(\n      schedulerPriorityLevel,\n      performConcurrentWorkOnRoot.bind(null, root),\n    );\n  }\n\n  // 2.2 \u5728FiberRoot\u5bf9\u8c61\u4e0a\u9762\u8bbe\u7f6e\u4e00\u4e9b\u6807\u8bb0, \u7528\u4e8e\u518d\u6b21\u8c03\u7528ensureRootIsScheduled\u65f6\u4f5c\u4e3a\u6bd4\u8f83.\n  root.callbackPriority = newCallbackPriority;\n  root.callbackNode = newCallbackNode;\n}",lang:"js"}),l.a.createElement("p",null,l.a.createElement("code",null,"ensureRootIsScheduled"),"\u7684\u903b\u8f91\u6bd4\u8f83\u6e05\u6670(\u6e90\u7801\u4e2d\u6bcf\u4e00\u6b65\u90fd\u6709\u82f1\u6587\u6ce8\u91ca), \u4e3b\u8981\u5206\u4e3a 2 \u90e8\u5206:"),l.a.createElement("ol",null,l.a.createElement("li",null,"\u524d\u534a\u90e8\u5206: \u786e\u5b9a\u662f\u5426\u9700\u8981\u6ce8\u518c\u65b0\u7684\u8c03\u5ea6(\u5982\u679c\u65e0\u9700\u65b0\u7684\u8c03\u5ea6, \u4f1a\u9000\u51fa\u51fd\u6570)"),l.a.createElement("li",null,"\u540e\u534a\u90e8\u5206: \u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1")),l.a.createElement("p",null,"\u5728\u524d\u534a\u90e8\u5206\u4e2d:"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u51fd\u6570",l.a.createElement("code",null,"getNextLanes"),"\u8fd4\u56de\u4e86\u9700\u8981\u8c03\u5ea6\u7684\u8f66\u9053(",l.a.createElement("code",null,"nextLanes"),")"),l.a.createElement("li",null,"\u51fd\u6570",l.a.createElement("code",null,"returnNextLanesPriority"),"\u8fd4\u56de\u4e86\u9700\u8981\u8c03\u5ea6\u7684\u8f66\u9053(",l.a.createElement("code",null,"nextLanes"),")\u4e2d, \u6240\u5360\u7528\u7684\u6700\u9ad8\u7684\u4f18\u5148\u7ea7."),l.a.createElement("li",null,"\u51fd\u6570",l.a.createElement("code",null,"lanePriorityToSchedulerPriority"),"\u628a",l.a.createElement("code",null,"lanePriority"),"\u8f6c\u6362\u6210",l.a.createElement("code",null,"SchedulerPriority"))),l.a.createElement("p",null,"\u540e\u534a\u90e8\u5206\u8c03\u7528",l.a.createElement("code",null,"scheduleSyncCallback \u6216 scheduleCallback"),":"),l.a.createElement(c["a"],{code:"export function scheduleCallback(\n  reactPriorityLevel: ReactPriorityLevel,\n  callback: SchedulerCallback,\n  options: SchedulerCallbackOptions | void | null,\n) {\n  // 1. \u628areactPriorityLevel\u8f6c\u6362\u4e3aSchedulerPriority\n  const priorityLevel = reactPriorityToSchedulerPriority(reactPriorityLevel);\n  // 2. \u6ce8\u518ctask\n  return Scheduler_scheduleCallback(priorityLevel, callback, options);\n}\n\nexport function scheduleSyncCallback(callback: SchedulerCallback) {\n  if (syncQueue === null) {\n    syncQueue = [callback];\n    // \u4f7f\u7528Scheduler_ImmediatePriority\u6ce8\u518ctask\n    immediateQueueCallbackNode = Scheduler_scheduleCallback(\n      Scheduler_ImmediatePriority,\n      flushSyncCallbackQueueImpl,\n    );\n  } else {\n    syncQueue.push(callback);\n  }\n  return fakeCallbackNode;\n}",lang:"js"}),l.a.createElement("p",null,"\u53ef\u89c1",l.a.createElement("code",null,"scheduleSyncCallback \u548c scheduleCallback"),"\u5747\u8c03\u7528",l.a.createElement("code",null,"Scheduler_scheduleCallback"),", \u552f\u4e00\u4e0d\u540c\u7684\u5c31\u662f\u4f18\u5148\u7ea7."),l.a.createElement("p",null,"\u7531\u4e8e\u6b64\u5904\u6d89\u53ca\u5230",l.a.createElement("code",null,"react-reconciler"),"\u5305\u548c",l.a.createElement("code",null,"scheduler"),"\u5305\u7684\u8854\u63a5, \u5c24\u5176\u5173\u6ce8\u5176\u4e2d\u4f18\u5148\u7ea7\u7684\u8f6c\u6362. \u901a\u8fc7\u68b3\u7406, \u5728",l.a.createElement("code",null,"task"),"\u6ce8\u518c\u8fc7\u7a0b\u4e2d, \u4e00\u5171\u5305\u542b\u4e86 3 \u79cd\u4f18\u5148\u7ea7."),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"LanePriority"),": \u5c5e\u4e8e",l.a.createElement("code",null,"react-reconciler"),"\u5305, \u5b9a\u4e49\u4e8e",l.a.createElement("code",null,"ReactFiberLane.js"),"(",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberLane.js#L46-L70"},"\u89c1\u6e90\u7801"),")."),l.a.createElement(c["a"],{code:"export const SyncLanePriority: LanePriority = 15;\nexport const SyncBatchedLanePriority: LanePriority = 14;\n\nconst InputDiscreteHydrationLanePriority: LanePriority = 13;\nexport const InputDiscreteLanePriority: LanePriority = 12;\n\n// .....\n\nconst OffscreenLanePriority: LanePriority = 1;\nexport const NoLanePriority: LanePriority = 0;",lang:"js"})),l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"reactPriorityLevel"),", \u5c5e\u4e8e",l.a.createElement("code",null,"react-reconciler"),"\u5305, \u5b9a\u4e49\u4e8e",l.a.createElement("code",null,"SchedulerWithReactIntegration.js"),"\u4e2d(",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/SchedulerWithReactIntegration.old.js#L65-L71"},"\u89c1\u6e90\u7801"),")."),l.a.createElement(c["a"],{code:"export const ImmediatePriority: ReactPriorityLevel = 99;\nexport const UserBlockingPriority: ReactPriorityLevel = 98;\nexport const NormalPriority: ReactPriorityLevel = 97;\nexport const LowPriority: ReactPriorityLevel = 96;\nexport const IdlePriority: ReactPriorityLevel = 95;\n// NoPriority is the absence of priority. Also React-only.\nexport const NoPriority: ReactPriorityLevel = 90;",lang:"js"})),l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"SchedulerPriority"),", \u5c5e\u4e8e",l.a.createElement("code",null,"scheduler"),"\u5305, \u5b9a\u4e49\u4e8e",l.a.createElement("code",null,"SchedulerPriorities.js"),"\u4e2d(",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/scheduler/src/SchedulerPriorities.js"},"\u89c1\u6e90\u7801"),")."),l.a.createElement(c["a"],{code:"export const NoPriority = 0;\nexport const ImmediatePriority = 1;\nexport const UserBlockingPriority = 2;\nexport const NormalPriority = 3;\nexport const LowPriority = 4;\nexport const IdlePriority = 5;",lang:"js"}))),l.a.createElement("ul",null,l.a.createElement("li",null,"\u4e0e",l.a.createElement("code",null,"fiber"),"\u6784\u9020\u8fc7\u7a0b\u76f8\u5173\u7684\u4f18\u5148\u7ea7(\u5982",l.a.createElement("code",null,"fiber.updateQueue"),",",l.a.createElement("code",null,"fiber.lanes"),")\u90fd\u4f7f\u7528",l.a.createElement("code",null,"LanePriority"),"."),l.a.createElement("li",null,"\u4e0e",l.a.createElement("code",null,"scheduler"),"\u8c03\u5ea6\u4e2d\u5fc3\u76f8\u5173\u7684\u4f18\u5148\u7ea7\u4f7f\u7528",l.a.createElement("code",null,"SchedulerPriority"),"."),l.a.createElement("li",null,l.a.createElement("code",null,"LanePriority"),"\u4e0e",l.a.createElement("code",null,"SchedulerPriority"),"\u901a\u8fc7",l.a.createElement("code",null,"ReactPriorityLevel"),"\u8fdb\u884c\u8f6c\u6362")),l.a.createElement("p",null,"\u5728",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/SchedulerWithReactIntegration.old.js#L93-L125"},l.a.createElement("code",null,"SchedulerWithReactIntegration.js"),"\u4e2d"),", \u8f6c\u6362\u5173\u7cfb\u5982\u4e0b:"),l.a.createElement(c["a"],{code:"// \u628a SchedulerPriority \u8f6c\u6362\u6210 ReactPriorityLevel\nexport function getCurrentPriorityLevel(): ReactPriorityLevel {\n  switch (Scheduler_getCurrentPriorityLevel()) {\n    case Scheduler_ImmediatePriority:\n      return ImmediatePriority;\n    case Scheduler_UserBlockingPriority:\n      return UserBlockingPriority;\n    case Scheduler_NormalPriority:\n      return NormalPriority;\n    case Scheduler_LowPriority:\n      return LowPriority;\n    case Scheduler_IdlePriority:\n      return IdlePriority;\n    default:\n      invariant(false, 'Unknown priority level.');\n  }\n}\n\n// \u628a ReactPriorityLevel \u8f6c\u6362\u6210 SchedulerPriority\nfunction reactPriorityToSchedulerPriority(reactPriorityLevel) {\n  switch (reactPriorityLevel) {\n    case ImmediatePriority:\n      return Scheduler_ImmediatePriority;\n    case UserBlockingPriority:\n      return Scheduler_UserBlockingPriority;\n    case NormalPriority:\n      return Scheduler_NormalPriority;\n    case LowPriority:\n      return Scheduler_LowPriority;\n    case IdlePriority:\n      return Scheduler_IdlePriority;\n    default:\n      invariant(false, 'Unknown priority level.');\n  }\n}",lang:"js"}),l.a.createElement("p",null,"\u5728",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberLane.js#L196-L247"},l.a.createElement("code",null,"ReactFiberLane.js"),"\u4e2d"),", \u8f6c\u6362\u5173\u7cfb\u5982\u4e0b:"),l.a.createElement(c["a"],{code:"export function schedulerPriorityToLanePriority(\n  schedulerPriorityLevel: ReactPriorityLevel,\n): LanePriority {\n  switch (schedulerPriorityLevel) {\n    case ImmediateSchedulerPriority:\n      return SyncLanePriority;\n    // ... \u7701\u7565\u90e8\u5206\u4ee3\u7801\n    default:\n      return NoLanePriority;\n  }\n}\n\nexport function lanePriorityToSchedulerPriority(\n  lanePriority: LanePriority,\n): ReactPriorityLevel {\n  switch (lanePriority) {\n    case SyncLanePriority:\n    case SyncBatchedLanePriority:\n      return ImmediateSchedulerPriority;\n    // ... \u7701\u7565\u90e8\u5206\u4ee3\u7801\n    default:\n      invariant(\n        false,\n        'Invalid update priority: %s. This is a bug in React.',\n        lanePriority,\n      );\n  }\n}",lang:"js"}),l.a.createElement("p",null,"\u7406\u6e05\u695a 3 \u79cd\u4f18\u5148\u7ea7\u7684\u5173\u7cfb\u4e4b\u540e, \u56de\u5230",l.a.createElement("code",null,"Scheduler_scheduleCallback"),"\u51fd\u6570, \u903b\u8f91\u5b8c\u5168\u8fdb\u5165\u4e86",l.a.createElement("code",null,"scheduler"),"\u5305. \u5bf9\u4e8e",l.a.createElement("code",null,"scheduler"),"\u5305\u5185\u90e8\u7684\u8fd0\u8f6c, \u653e\u5728",l.a.createElement("code",null,"scheduler \u8c03\u5ea6\u673a\u5236"),"\u4e2d\u8be6\u7ec6\u89e3\u8bfb."),l.a.createElement("p",null,"\u6b64\u5904\u6574\u7406\u51fa",l.a.createElement("code",null,"\u8c03\u5ea6\u9636\u6bb5"),"\u4f18\u5148\u7ea7\u76f8\u5173\u7684\u903b\u8f91:"),l.a.createElement("ol",null,l.a.createElement("li",null,"\u83b7\u53d6\u5f53\u524d\u6700\u9700\u8981\u88ab\u8c03\u5ea6\u7684\u8f66\u9053(",l.a.createElement("code",null,"Lanes"),")\u53ca\u5176\u5360\u7528\u7684\u6700\u9ad8\u4f18\u5148\u7ea7",l.a.createElement("code",null,"newCallbackPriority")),l.a.createElement("li",null,"\u6ce8\u518c\u8c03\u5ea6\u4efb\u52a1",l.a.createElement("code",null,"task"),", \u4f20\u5165\u7684\u53c2\u6570\u662f\u5f53\u524d\u7684\u4f18\u5148\u7ea7\u548c\u56de\u8c03\u51fd\u6570",l.a.createElement("ul",null,l.a.createElement("li",null,"\u6ce8\u518c",l.a.createElement("code",null,"task"),"\u7684\u8fc7\u7a0b\u4e2d, \u9700\u8981\u4f18\u5148\u7ea7\u8f6c\u6362(",l.a.createElement("code",null,"LanePriority --\x3e ReactPriorityLevel --\x3e SchedulerPriority"),")"),l.a.createElement("li",null,"\u5728",l.a.createElement("code",null,"scheduler"),"\u5305\u4e2d\u7ef4\u62a4\u7684",l.a.createElement("code",null,"task"),"\u961f\u5217, \u4f7f\u7528\u7684\u4f18\u5148\u7ea7\u7c7b\u578b\u662f",l.a.createElement("code",null,"SchedulerPriority")),l.a.createElement("li",null,l.a.createElement("code",null,"task"),"\u961f\u5217\u4f1a\u6309\u7167\u8fc7\u671f\u65f6\u95f4",l.a.createElement("code",null,"expirationTime"),"\u4ece\u5c0f\u5230\u5927\u8fdb\u884c\u5806\u6392\u5e8f, \u4f18\u5148\u7ea7\u8d8a\u9ad8\u7684, \u8fc7\u671f\u65f6\u95f4\u8d8a\u5c0f"))),l.a.createElement("li",null,"\u8c03\u5ea6\u4e2d\u5fc3(",l.a.createElement("code",null,"scheduler"),"\u5305)\u8d1f\u8d23\u5728\u4e0b\u4e00\u4e2a\u6d4f\u89c8\u5668\u4e8b\u4ef6\u5faa\u73af\u4f9d\u6b21\u6267\u884c",l.a.createElement("code",null,"task"),"\u961f\u5217\u4e2d\u7684\u56de\u8c03\u4efb\u52a1(\u8be6\u89c1",l.a.createElement("code",null,"scheduler \u8c03\u5ea6\u673a\u5236"),")")),l.a.createElement("h3",{id:"fiber-\u6811\u6784\u9020\u9636\u6bb5"},l.a.createElement(r["AnchorLink"],{to:"#fiber-\u6811\u6784\u9020\u9636\u6bb5","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"fiber \u6811\u6784\u9020\u9636\u6bb5"),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"\u8c03\u5ea6\u9636\u6bb5"),", \u6267\u884c\u5b8c",l.a.createElement("code",null,"react-reconciler"),"\u5305\u7684\u6700\u540e\u4e00\u4e2a\u51fd\u6570",l.a.createElement("code",null,"scheduleCallback"),"\u4e4b\u540e, \u5373\u5728",l.a.createElement("code",null,"scheduler"),"\u5305\u4e2d\u6ce8\u518c\u4e86",l.a.createElement("code",null,"task"),". \u6b64\u540e,\u63a7\u5236",l.a.createElement("code",null,"react"),"\u8fd0\u884c\u65f6\u7684\u4e3b\u52a8\u6743\u8f6c\u79fb\u5230\u4e86",l.a.createElement("code",null,"scheduler"),"\u5305\u4e2d, ",l.a.createElement("code",null,"react-reconciler"),"\u5305\u53ea\u9700\u8981\u88ab\u52a8\u7b49\u5f85\u56de\u8c03."),l.a.createElement("p",null,"\u8c03\u5ea6\u4e2d\u5fc3\u4f9d\u6b21\u6267\u884c",l.a.createElement("code",null,"task"),"\u961f\u5217\u4e2d\u7684\u56de\u8c03\u4efb\u52a1, \u5f53\u6267\u884c",l.a.createElement("code",null,"task.callback"),"\u65f6, \u903b\u8f91\u518d\u6b21\u56de\u5230",l.a.createElement("code",null,"react-reconciler"),"\u5305, \u6b64\u65f6\u88ab\u8c03\u7528\u7684\u51fd\u6570\u662f",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L965-L1045"},l.a.createElement("code",null,"performSyncWorkOnRoot"),"(\u53ea\u5728",l.a.createElement("code",null,"Legacy"),"\u6a21\u5f0f)"),"\u6216",l.a.createElement(r["Link"],{to:"https://github.com/facebook/react/blob/v17.0.1/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L740-L839"},l.a.createElement("code",null,"performConcurrentWorkOnRoot"))),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"performSyncWorkOnRoot"),"\u548c",l.a.createElement("code",null,"performConcurrentWorkOnRoot"),"\u7684\u8c03\u7528\u94fe\u8def\u4e2d, \u672c\u8282\u5148\u5173\u5fc3\u4f18\u5148\u7ea7\u7684\u4f7f\u7528."),l.a.createElement("p",null,"\u5176\u4e2d",l.a.createElement("code",null,"prepareFreshStack"),"\u51fd\u6570:"),l.a.createElement(c["a"],{code:"function prepareFreshStack(root: FiberRoot, lanes: Lanes) {\n  root.finishedWork = null;\n  root.finishedLanes = NoLanes;\n\n  const timeoutHandle = root.timeoutHandle;\n  if (timeoutHandle !== noTimeout) {\n    // The root previous suspended and scheduled a timeout to commit a fallback\n    // state. Now that we have additional work, cancel the timeout.\n    root.timeoutHandle = noTimeout;\n    // $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above\n    cancelTimeout(timeoutHandle);\n  }\n\n  if (workInProgress !== null) {\n    let interruptedWork = workInProgress.return;\n    while (interruptedWork !== null) {\n      unwindInterruptedWork(interruptedWork);\n      interruptedWork = interruptedWork.return;\n    }\n  }\n  workInProgressRoot = root;\n  workInProgress = createWorkInProgress(root.current, null);\n  workInProgressRootRenderLanes = subtreeRenderLanes = workInProgressRootIncludedLanes = lanes;\n  workInProgressRootExitStatus = RootIncomplete;\n  workInProgressRootFatalError = null;\n  workInProgressRootSkippedLanes = NoLanes;\n  workInProgressRootUpdatedLanes = NoLanes;\n  workInProgressRootPingedLanes = NoLanes;\n}",lang:"js"}),l.a.createElement("p",null,"\u4ece\u51fd\u6570\u7b7e\u540d\u6765\u770b",l.a.createElement("code",null,"prepareFreshStack(root: FiberRoot, lanes: Lanes)"),",",l.a.createElement("code",null,"prepareFreshStack"),"\u7684\u5b57\u9762\u610f\u601d\u662f\u5237\u65b0\u6808\u5e27, \u5728\u65b9\u6cd5\u4f53\u4e2d, \u4e3b\u8981\u903b\u8f91\u662f\u91cd\u7f6e\u5168\u5c40\u53d8\u91cf. \u5176\u4e2d\u6709\u5173",l.a.createElement("code",null,"lanes"),"\u7684\u64cd\u4f5c"),l.a.createElement(c["a"],{code:"workInProgressRootRenderLanes = subtreeRenderLanes = workInProgressRootIncludedLanes = lanes;",lang:"js"}),l.a.createElement("p",null,"\u5728"),l.a.createElement("h3",{id:"\u8f93\u51fa"},l.a.createElement(r["AnchorLink"],{to:"#\u8f93\u51fa","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u8f93\u51fa"),l.a.createElement("h2",{id:"\u603b\u7ed3"},l.a.createElement(r["AnchorLink"],{to:"#\u603b\u7ed3","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u603b\u7ed3")))}));n["default"]=e=>{var n=l.a.useContext(r["context"]),t=n.demos;return l.a.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&r["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),l.a.createElement(o,{demos:t})}},wOdG:function(e,n,t){e.exports=t.p+"static/reactfiberworkloop.59263ed5.png"}}]);
(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[22],{"1XtG":function(e,n,t){e.exports=t.p+"static/useEffect-update-WorkInProgressHook-2.19e9ae54.png"},"4dQB":function(e,n,t){e.exports=t.p+"static/beginWork.1f6efe6d.png"},"4z7d":function(e,n,t){e.exports=t.p+"static/dispatchAction.162c6e74.png"},AbAg:function(e,n,t){e.exports=t.p+"static/useEffect-create-WorkInProgressHook.45e7d72b.png"},Kn9z:function(e,n,t){e.exports=t.p+"static/useEffect-update-WorkInProgressHook-1.ed05b8b1.png"},"LA/F":function(e,n,t){e.exports=t.p+"static/hook-update.3632a969.png"},MZF8:function(e,n,t){"use strict";var a=t("ogwx");t.d(n,"a",(function(){return a["b"]}));t("VCU9")},O1S9:function(e,n,t){"use strict";t.r(n);var a=t("q1tI"),o=t.n(a),l=t("dEAq"),r=t("Zxc8"),c=t("H1Ra"),u=o.a.memo((e=>{var n=e.demos,a=n["hook-demo"].component;return o.a.createElement(o.a.Fragment,null,o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"markdown"},o.a.createElement("h1",{id:"hook-\u539f\u7406"},o.a.createElement(l["AnchorLink"],{to:"#hook-\u539f\u7406","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"hook \u539f\u7406"),o.a.createElement("p",null,"\u9996\u5148\u5f15\u5165\u5b98\u7f51\u4e0a\u5bf9",o.a.createElement(l["Link"],{to:"https://zh-hans.reactjs.org/docs/hooks-intro.html"},"hook \u7684\u89e3\u91ca"),"."),o.a.createElement("ol",null,o.a.createElement("li",null,o.a.createElement("code",null,"hook"),"\u53ea\u80fd\u7528\u4e8e",o.a.createElement("code",null,"function"),"\u4e2d"),o.a.createElement("li",null,"\u53ef\u4ee5\u4f7f\u7528",o.a.createElement("code",null,"state"),"\u4ee5\u53ca\u5176\u4ed6\u7684",o.a.createElement("code",null,"React"),"\u7279\u6027")),o.a.createElement("p",null,"\u6f14\u793a\u4ee3\u7801:")),o.a.createElement(r["default"],n["hook-demo"].previewerProps,o.a.createElement(a,null)),o.a.createElement("div",{className:"markdown"},o.a.createElement("h2",{id:"\u65b0\u589e\u9636\u6bb5"},o.a.createElement(l["AnchorLink"],{to:"#\u65b0\u589e\u9636\u6bb5","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"\u65b0\u589e\u9636\u6bb5"),o.a.createElement("h3",{id:"\u521b\u5efa-fiber"},o.a.createElement(l["AnchorLink"],{to:"#\u521b\u5efa-fiber","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"\u521b\u5efa fiber"),o.a.createElement("p",null,"\u901a\u8fc7",o.a.createElement(l["AnchorLink"],{to:"./render#beginWork"},"fiber \u6784\u5efa(\u65b0\u589e\u8282\u70b9)"),"\u4e2d\u7684\u4ecb\u7ecd, \u521b\u5efa\u8282\u70b9\u90fd\u662f\u5728",o.a.createElement("code",null,"beginWork"),"\u9636\u6bb5."),o.a.createElement("p",null,o.a.createElement("code",null,"function"),"\u7c7b\u578b\u8282\u70b9\u5728\u65b0\u589e\u65f6\u8c03\u7528",o.a.createElement("code",null,"mountIndeterminateComponent")),o.a.createElement(c["a"],{code:"// \u7701\u7565\u4e86\u4e0e\u521b\u5efafiber\u65e0\u5173\u7684\u903b\u8f91\nfunction mountIndeterminateComponent(\n  _current,\n  workInProgress,\n  Component,\n  renderExpirationTime,\n) {\n  const props = workInProgress.pendingProps;\n  let value;\n  value = renderWithHooks(\n    null,\n    workInProgress,\n    Component,\n    props,\n    context,\n    renderExpirationTime,\n  );\n  // React DevTools reads this flag.\n  workInProgress.effectTag |= PerformedWork;\n  // Proceed under the assumption that this is a function component\n  workInProgress.tag = FunctionComponent;\n  reconcileChildren(null, workInProgress, value, renderExpirationTime);\n  return workInProgress.child;\n}",lang:"js"}),o.a.createElement("p",null,"\u6838\u5fc3\u6b65\u9aa4:"),o.a.createElement("ol",null,o.a.createElement("li",null,"\u8c03\u7528",o.a.createElement("code",null,"renderWithHooks"),"(\u76ee\u7684\u548c\u8c03\u7528",o.a.createElement("code",null,"classInstance.render"),"\u4e00\u6837),\u8fd4\u56de\u4ee3\u8868\u5b50\u8282\u70b9\u7684",o.a.createElement("code",null,"reactElement")),o.a.createElement("li",null,"\u5c06\u6b65\u9aa4 1 \u4e2d\u5f97\u5230\u7684",o.a.createElement("code",null,"reactElement"),"\u4f20\u5165",o.a.createElement("code",null,"reconcileChildren"),"\u4e2d\u53bb\u6784\u5efa",o.a.createElement("code",null,"fiber"),"\u6b21\u7ea7\u5b50\u8282\u70b9")),o.a.createElement("p",null,"\u903b\u8f91\u8fdb\u5165",o.a.createElement("code",null,"ReactFiberHooks"),"\u4e2d, \u8fd9\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u5de5\u4f5c\u7a7a\u95f4, \u7ba1\u7406\u6240\u6709\u7684",o.a.createElement("code",null,"hook"),"\u5bf9\u8c61."),o.a.createElement(c["a"],{code:"export function renderWithHooks<Props, SecondArg>(\n  current: Fiber | null,\n  workInProgress: Fiber,\n  Component: (p: Props, arg: SecondArg) => any,\n  props: Props,\n  secondArg: SecondArg,\n  nextRenderExpirationTime: ExpirationTime,\n): any {\n  renderExpirationTime = nextRenderExpirationTime;\n  currentlyRenderingFiber = workInProgress;\n\n  workInProgress.memoizedState = null;\n  workInProgress.updateQueue = null;\n  workInProgress.expirationTime = NoWork;\n\n  // 1.\u8bbe\u7f6e\u5168\u5c40HooksDispatcher\n  ReactCurrentDispatcher.current =\n    current === null || current.memoizedState === null\n      ? HooksDispatcherOnMount\n      : HooksDispatcherOnUpdate;\n  // 2.\u6267\u884c`Component`\n  let children = Component(props, secondArg);\n\n  renderExpirationTime = NoWork;\n  currentlyRenderingFiber = (null: any);\n  currentHook = null;\n  workInProgressHook = null;\n  didScheduleRenderPhaseUpdate = false;\n  return children;\n}",lang:"js"}),o.a.createElement("p",null,"\u6838\u5fc3\u6b65\u9aa4:"),o.a.createElement("ol",null,o.a.createElement("li",null,"\u8bbe\u7f6e\u5f53\u524d",o.a.createElement("code",null,"hook"),"\u64cd\u4f5c\u4ee3\u7406",o.a.createElement("code",null,"ReactCurrentDispatcher"),o.a.createElement("ul",null,o.a.createElement("li",null,"\u65b0\u589e\u8282\u70b9, \u8bbe\u7f6e\u4e3a",o.a.createElement("code",null,"HooksDispatcherOnMount")),o.a.createElement("li",null,"\u66f4\u65b0\u8282\u70b9, \u8bbe\u7f6e\u4e3a",o.a.createElement("code",null,"HooksDispatcherOnUpdate")))),o.a.createElement("li",null,"\u6267\u884c",o.a.createElement("code",null,"Component()"))),o.a.createElement("h3",{id:"\u521b\u5efa-hook"},o.a.createElement(l["AnchorLink"],{to:"#\u521b\u5efa-hook","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"\u521b\u5efa hook"),o.a.createElement("p",null,"\u5728\u6267\u884c",o.a.createElement("code",null,"Example()"),"\u7684\u65f6\u5019, \u8c03\u7528",o.a.createElement("code",null,"useState(0)")),o.a.createElement("p",null,"\u8ddf\u8fdb",o.a.createElement("code",null,"useState"),"\u903b\u8f91, \u6700\u7ec8\u6267\u884c",o.a.createElement("code",null,"ReactCurrentDispatcher.current.useState(initialState)"),"."),o.a.createElement("p",null,"\u65b0\u589e\u8282\u70b9, ",o.a.createElement("code",null,"useState"),"\u5bf9\u5e94",o.a.createElement("code",null,"mountState")),o.a.createElement(c["a"],{code:"function mountState<S>(\n  initialState: (() => S) | S,\n): [S, Dispatch<BasicStateAction<S>>] {\n  //1. \u521b\u5efahook\u5bf9\u8c61, \u5e76\u4e14\u6302\u8f7d\u5230\u5f53\u524d`fiber.memoizedState`\u4e0a,workInProgressHook\u6307\u5411\u5f53\u524dhook\n  const hook = mountWorkInProgressHook();\n  if (typeof initialState === 'function') {\n    // $FlowFixMe: Flow doesn't like mixed types\n    initialState = initialState();\n  }\n  //2. \u628ainitialState\u8bbe\u7f6e\u5230`hook`\u5bf9\u8c61\u4e2d\n  hook.memoizedState = hook.baseState = initialState;\n  //3. \u8bbe\u7f6ehook.queue\n  // \u8bbe\u7f6elastRenderedReducer,lastRenderedState,dispatch\n  const queue = (hook.queue = {\n    pending: null,\n    dispatch: null,\n    lastRenderedReducer: basicStateReducer,\n    lastRenderedState: (initialState: any),\n  });\n  // \u8bbe\u7f6equeue.dispatch, \u5f53\u524dfiber\u88ab\u5173\u8054\u5230queue.dispatch\u4e2d\n  const dispatch: Dispatch<\n    BasicStateAction<S>,\n  > = (queue.dispatch = (dispatchAction.bind(\n    null,\n    currentlyRenderingFiber,\n    queue,\n  ): any));\n  //4. \u8fd4\u56dedispatchAction\u64cd\u4f5c\u63a5\u53e3\n  return [hook.memoizedState, dispatch];\n}",lang:"js"}),o.a.createElement("p",null,"\u6838\u5fc3\u6b65\u9aa4:"),o.a.createElement("ol",null,o.a.createElement("li",null,"\u521b\u5efa",o.a.createElement("code",null,"hook"),"\u5bf9\u8c61, \u6302\u8f7d\u5230\u5f53\u524d",o.a.createElement("code",null,"fiber.memoizedState"),",",o.a.createElement("code",null,"workInProgressHook"),"\u6307\u5411\u6b64",o.a.createElement("code",null,"hook")),o.a.createElement("li",null,"\u8bbe\u7f6e",o.a.createElement("code",null,"hook.queue"),", \u548c\u5f53\u524d",o.a.createElement("code",null,"fiber"),"\u8fdb\u884c\u5173\u8054")),o.a.createElement("p",null,"\u65b0\u589e\u8282\u70b9, ",o.a.createElement("code",null,"useEffect"),"\u5bf9\u5e94",o.a.createElement("code",null,"mountEffect")),o.a.createElement(c["a"],{code:"function mountEffect(\n  create: () => (() => void) | void,\n  deps: Array<mixed> | void | null,\n): void {\n  // \u6ce8\u610f\u8fd9\u91cc\u6307\u5b9a\u4e86\u4e24\u79cdtag\n  return mountEffectImpl(\n    UpdateEffect | PassiveEffect, // fiber.effectTag \u9002\u7528\u4e8efiber\u5bf9\u8c61\n    HookPassive, // effect.tag \u9002\u7528\u4e8eeffect\u5bf9\u8c61\n    create,\n    deps,\n  );\n}\n\nfunction mountEffectImpl(fiberEffectTag, hookEffectTag, create, deps): void {\n  const hook = mountWorkInProgressHook();\n  const nextDeps = deps === undefined ? null : deps;\n  currentlyRenderingFiber.effectTag |= fiberEffectTag;\n  hook.memoizedState = pushEffect(\n    HookHasEffect | hookEffectTag, //\u518d\u6b21\u6307\u5b9a effect.tag\n    create,\n    undefined,\n    nextDeps,\n  );\n}\n\nfunction pushEffect(tag, create, destroy, deps) {\n  // \u521b\u5efa\u65b0\u7684effect\u5bf9\u8c61\n  const effect: Effect = {\n    tag,\n    create,\n    destroy,\n    deps,\n    // Circular\n    next: (null: any),\n  };\n  // \u5c06effect\u5bf9\u8c61\u6dfb\u52a0\u5230fiber.updateQueue\u961f\u5217\u4e2d\n  let componentUpdateQueue: null | FunctionComponentUpdateQueue = (currentlyRenderingFiber.updateQueue: any);\n  if (componentUpdateQueue === null) {\n    componentUpdateQueue = createFunctionComponentUpdateQueue();\n    currentlyRenderingFiber.updateQueue = (componentUpdateQueue: any);\n    componentUpdateQueue.lastEffect = effect.next = effect;\n  } else {\n    const lastEffect = componentUpdateQueue.lastEffect;\n    if (lastEffect === null) {\n      componentUpdateQueue.lastEffect = effect.next = effect;\n    } else {\n      const firstEffect = lastEffect.next;\n      lastEffect.next = effect;\n      effect.next = firstEffect;\n      componentUpdateQueue.lastEffect = effect;\n    }\n  }\n  return effect;\n}",lang:"js"}),o.a.createElement("p",null,"\u6838\u5fc3\u6b65\u9aa4:"),o.a.createElement("ol",null,o.a.createElement("li",null,"\u521b\u5efa",o.a.createElement("code",null,"hook"),"\u5bf9\u8c61, \u5e76\u4e14\u6dfb\u52a0\u5230",o.a.createElement("code",null,"hook"),"\u961f\u5217\u4e2d,",o.a.createElement("code",null,"workInProgressHook"),"\u6307\u5411\u6b64",o.a.createElement("code",null,"hook")),o.a.createElement("li",null,"\u8bbe\u7f6e",o.a.createElement("code",null,"fiber.effectTag = UpdateEffect | PassiveEffect")),o.a.createElement("li",null,"\u521b\u5efa",o.a.createElement("code",null,"effect"),"\u5bf9\u8c61(\u8bbe\u7f6e",o.a.createElement("code",null,"effect.tag = HookHasEffect | HookPassive"),"), \u5e76\u5c06",o.a.createElement("code",null,"effect"),"\u6dfb\u52a0\u5230",o.a.createElement("code",null,"fiber.UpdateQueue"),"\u961f\u5217\u4e2d")),o.a.createElement("p",null,"\u5728\u6574\u4e2a\u521b\u5efa",o.a.createElement("code",null,"hook"),"\u9636\u6bb5, \u4e3b\u8981\u6d41\u7a0b\u8868\u793a\u5982\u4e0b:"),o.a.createElement("p",null,o.a.createElement("img",{src:t("4dQB"),alt:""})),o.a.createElement("h3",{id:"\u6267\u884c-hook"},o.a.createElement(l["AnchorLink"],{to:"#\u6267\u884c-hook","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"\u6267\u884c hook"),o.a.createElement("p",null,"\u4ece\u4ee5\u4e0a\u6d41\u7a0b\u56fe\u53ef\u4ee5\u770b\u5230, \u6267\u884c",o.a.createElement("code",null,"function"),"\u7684\u65f6\u5019, \u53ea\u662f\u521b\u5efa\u4e86",o.a.createElement("code",null,"hook"),", \u4f46\u662f\u5e76\u6ca1\u6709\u6267\u884c",o.a.createElement("code",null,"hook.create"),".\u5728 fiber \u6784\u5efa(\u65b0\u589e\u8282\u70b9) \u4e2d\u6709\u4ecb\u7ecd, ",o.a.createElement("code",null,"commitRoot"),"\u5206\u4e3a",o.a.createElement(l["AnchorLink"],{to:"./render#commit%E9%98%B6%E6%AE%B5"},"3 \u4e2a\u9636\u6bb5")),o.a.createElement("p",null,"\u7b2c\u4e00\u4e2a\u9636\u6bb5",o.a.createElement("code",null,"commitBeforeMutationEffects"),"\u5bf9",o.a.createElement("code",null,"Passive"),"\u7c7b\u578b\u7684 tag \u505a\u4e86\u7279\u6b8a\u5904\u7406.\u5982\u679c",o.a.createElement("code",null,"function"),"\u7c7b\u578b\u7684",o.a.createElement("code",null,"fiber"),"\u4f7f\u7528\u4e86",o.a.createElement("code",null,"hook"),"api,\u4f1a\u8bbe\u7f6e",o.a.createElement("code",null,"fiber.effectTag |= Passive")),o.a.createElement(c["a"],{code:"function commitBeforeMutationEffects() {\n  while (nextEffect !== null) {\n    if (\n      !shouldFireAfterActiveInstanceBlur &&\n      focusedInstanceHandle !== null &&\n      isFiberHiddenOrDeletedAndContains(nextEffect, focusedInstanceHandle)\n    ) {\n      shouldFireAfterActiveInstanceBlur = true;\n      beforeActiveInstanceBlur();\n    }\n    const effectTag = nextEffect.effectTag;\n    // `Passive`\u7c7b\u578b\u7684tag\u505a\u4e86\u7279\u6b8a\u5904\u7406.\n    if ((effectTag & Passive) !== NoEffect) {\n      // If there are passive effects, schedule a callback to flush at\n      // the earliest opportunity.\n      if (!rootDoesHavePassiveEffects) {\n        rootDoesHavePassiveEffects = true;\n        // \u9700\u8981\u6ce8\u610f, \u6b64\u5904\u7684\u56de\u8c03\u51fd\u6570\u662f\u901a\u8fc7\u8c03\u5ea6\u5668\u6267\u884c\u7684, \u6240\u4ee5\u662f\u4e00\u4e2a\u5f02\u6b65\u56de\u8c03\n\n        scheduleCallback(NormalPriority, () => {\n          flushPassiveEffects(); // \u6267\u884chook\u7684\u5165\u53e3\n          return null;\n        });\n      }\n    }\n    nextEffect = nextEffect.nextEffect;\n  }\n}",lang:"js"}),o.a.createElement("p",null,"\u5f02\u6b65\u56de\u8c03:"),o.a.createElement("p",null,o.a.createElement("code",null,"flushPassiveEffectsImpl -> commitPassiveHookEffects")),o.a.createElement(c["a"],{code:"export function commitPassiveHookEffects(finishedWork: Fiber): void {\n  if ((finishedWork.effectTag & Passive) !== NoEffect) {\n    switch (finishedWork.tag) {\n      case FunctionComponent:\n      case ForwardRef:\n      case SimpleMemoComponent:\n      case Block:\n          commitHookEffectListUnmount(\n            HookPassive | HookHasEffect,\n            finishedWork,\n          );\n          commitHookEffectListMount(HookPassive | HookHasEffect, finishedWork);\n        break;\n      }\n      default:\n        break;\n    }\n  }\n}\n// \u6267\u884cdestroy\u65b9\u6cd5\nfunction commitHookEffectListUnmount(tag: number, finishedWork: Fiber) {\n  const updateQueue: FunctionComponentUpdateQueue | null = (finishedWork.updateQueue: any);\n  const lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;\n  if (lastEffect !== null) {\n    const firstEffect = lastEffect.next;\n    let effect = firstEffect;\n    do {\n      if ((effect.tag & tag) === tag) {\n        // Unmount\n        const destroy = effect.destroy;\n        effect.destroy = undefined;\n        if (destroy !== undefined) {\n          destroy();\n        }\n      }\n      effect = effect.next;\n    } while (effect !== firstEffect);\n  }\n}\n// \u6267\u884ccreate\u65b9\u6cd5\nfunction commitHookEffectListMount(tag: number, finishedWork: Fiber) {\n  const updateQueue: FunctionComponentUpdateQueue | null = (finishedWork.updateQueue: any);\n  const lastEffect = updateQueue !== null ? updateQueue.lastEffect : null;\n  if (lastEffect !== null) {\n    const firstEffect = lastEffect.next;\n    let effect = firstEffect;\n    do {\n      if ((effect.tag & tag) === tag) {\n        // Mount\n        const create = effect.create;\n        effect.destroy = create();\n      }\n      effect = effect.next;\n    } while (effect !== firstEffect);\n  }\n}",lang:"js"}),o.a.createElement("h2",{id:"\u66f4\u65b0\u9636\u6bb5"},o.a.createElement(l["AnchorLink"],{to:"#\u66f4\u65b0\u9636\u6bb5","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"\u66f4\u65b0\u9636\u6bb5"),o.a.createElement("h4",{id:"dispatchaction-\u89e6\u53d1\u8c03\u5ea6"},o.a.createElement(l["AnchorLink"],{to:"#dispatchaction-\u89e6\u53d1\u8c03\u5ea6","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"dispatchAction \u89e6\u53d1\u8c03\u5ea6"),o.a.createElement(c["a"],{code:"function dispatchAction<S, A>(\n  fiber: Fiber,\n  queue: UpdateQueue<S, A>,\n  action: A,\n) {\n  // 1. \u83b7\u53d6expirationTime\n  const currentTime = requestCurrentTimeForUpdate();\n  const suspenseConfig = requestCurrentSuspenseConfig();\n  const expirationTime = computeExpirationForFiber(\n    currentTime,\n    fiber,\n    suspenseConfig,\n  );\n\n  // 2. \u521b\u5efaupdate\u5bf9\u8c61\n  const update: Update<S, A> = {\n    expirationTime,\n    suspenseConfig,\n    action,\n    eagerReducer: null,\n    eagerState: null,\n    next: (null: any),\n  };\n  //3. \u5c06update\u5bf9\u8c61\u8bbe\u7f6e\u5230hook.queue\u961f\u5217\u5f53\u4e2d\n  // Append the update to the end of the list.\n  const pending = queue.pending;\n  if (pending === null) {\n    // This is the first update. Create a circular list.\n    update.next = update;\n  } else {\n    update.next = pending.next;\n    pending.next = update;\n  }\n  queue.pending = update;\n\n  const alternate = fiber.alternate;\n\n  //4. \u8bf7\u6c42\u8c03\u5ea6\n  scheduleUpdateOnFiber(fiber, expirationTime);\n  }\n}",lang:"js"}),o.a.createElement("p",null,o.a.createElement("code",null,"dispatchAction"),"\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684",o.a.createElement("code",null,"update"),"\u5bf9\u8c61, \u6dfb\u52a0\u5230",o.a.createElement("code",null,"hook.queue.pending"),"\u961f\u5217\u4e4b\u540e."),o.a.createElement("p",null,o.a.createElement("img",{src:t("4z7d"),alt:""})),o.a.createElement("h3",{id:"\u66f4\u65b0-fiber"},o.a.createElement(l["AnchorLink"],{to:"#\u66f4\u65b0-fiber","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"\u66f4\u65b0 fiber"),o.a.createElement("p",null,o.a.createElement("code",null,"scheduleUpdateOnFiber"),"\u8bf7\u6c42\u8c03\u5ea6, \u968f\u540e\u518d\u6b21\u6784\u5efa",o.a.createElement("code",null,"fiber"),"\u6811, ",o.a.createElement("code",null,"renderWithHooks"),"\u4f5c\u4e3a\u6784\u5efa",o.a.createElement("code",null,"fiber"),"\u6811\u8fc7\u7a0b\u4e2d\u7684\u4e00\u73af, \u4e5f\u4f1a\u518d\u6b21\u6267\u884c."),o.a.createElement("h4",{id:"\u66f4\u65b0-hook"},o.a.createElement(l["AnchorLink"],{to:"#\u66f4\u65b0-hook","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"\u66f4\u65b0 hook"),o.a.createElement("p",null,o.a.createElement("code",null,"renderWithHooks"),"\u8c03\u7528\u6808\u4e2d, \u6267\u884c",o.a.createElement("code",null,"\bExample"),"\u51fd\u6570\u4f53, \u8c03\u7528",o.a.createElement("code",null,"useState"),",",o.a.createElement("code",null,"useEffect"),"\u7b49\u51fd\u6570\u91cd\u65b0\u6784\u9020",o.a.createElement("code",null,"hook"),"\u5bf9\u8c61."),o.a.createElement("blockquote",null,o.a.createElement("p",null,o.a.createElement("code",null,"currentHook"),"\u548c",o.a.createElement("code",null,"workInProgressHook"),"\u662f\u4e24\u4e2a\u6307\u9488, \u5206\u522b\u6307\u5411\u8001",o.a.createElement("code",null,"hook"),"\u548c\u65b0",o.a.createElement("code",null,"hook"))),o.a.createElement("p",null,o.a.createElement("code",null,"updateWorkInProgressHook"),"\u7ef4\u62a4\u4e86\u5f53\u524d",o.a.createElement("code",null,"fiber"),"\u8282\u70b9",o.a.createElement("code",null,"\u65b0\u65e7hook"),"\u6307\u9488\u7684\u79fb\u52a8, \u4fdd\u8bc1",o.a.createElement("code",null,"currentHook"),"\u548c",o.a.createElement("code",null,"workInProgressHook"),"\u6709\u6b63\u786e\u7684\u6307\u5411"),o.a.createElement(c["a"],{code:"function updateWorkInProgressHook(): Hook {\n  let nextCurrentHook: null | Hook;\n  // \u521a\u8fdb\u5165\u8be5fiber\u8282\u70b9, currentHook\u4e3anull\n  if (currentHook === null) {\n    // \u62ff\u5230\u5f53\u524dfiber\u8282\u70b9\u7684\u526f\u672c(\u5bf9\u5e94\u8001\u8282\u70b9)\n    const current = currentlyRenderingFiber.alternate;\n    if (current !== null) {\n      nextCurrentHook = current.memoizedState;\n    } else {\n      nextCurrentHook = null;\n    }\n  } else {\n    nextCurrentHook = currentHook.next;\n  }\n\n  let nextWorkInProgressHook: null | Hook;\n  if (workInProgressHook === null) {\n    nextWorkInProgressHook = currentlyRenderingFiber.memoizedState;\n  } else {\n    nextWorkInProgressHook = workInProgressHook.next;\n  }\n\n  if (nextWorkInProgressHook !== null) {\n    // There's already a work-in-progress. Reuse it.\n    workInProgressHook = nextWorkInProgressHook;\n    nextWorkInProgressHook = workInProgressHook.next;\n\n    currentHook = nextCurrentHook;\n  } else {\n    // Clone from the current hook.\n    currentHook = nextCurrentHook;\n    // \u521b\u5efa\u65b0\u7684hook\u8282\u70b9, \u6700\u540e\u6dfb\u52a0\u5230\u961f\u5217\n    const newHook: Hook = {\n      memoizedState: currentHook.memoizedState,\n\n      baseState: currentHook.baseState,\n      baseQueue: currentHook.baseQueue,\n      queue: currentHook.queue,\n\n      next: null,\n    };\n\n    if (workInProgressHook === null) {\n      // This is the first hook in the list.\n      currentlyRenderingFiber.memoizedState = workInProgressHook = newHook;\n    } else {\n      // Append to the end of the list.\n      workInProgressHook = workInProgressHook.next = newHook;\n    }\n  }\n  return workInProgressHook;\n}",lang:"js"}),o.a.createElement("p",null,"\u5bf9\u4e8e",o.a.createElement("code",null,"useState"),", \u8c03\u7528",o.a.createElement("code",null,"updateReducer"),":"),o.a.createElement("ol",null,o.a.createElement("li",null,"\u8c03\u7528",o.a.createElement("code",null,"updateWorkInProgressHook"),"\u521b\u5efa\u65b0\u7684",o.a.createElement("code",null,"hook"),"\u5bf9\u8c61",o.a.createElement("ul",null,o.a.createElement("li",null,"\u6ce8\u610f\u65b0",o.a.createElement("code",null,"hook"),"\u5b9e\u9645\u4e0a\u662f\u65e7",o.a.createElement("code",null,"hook"),"\u7684\u6d45\u62f7\u8d1d")))),o.a.createElement("p",null,o.a.createElement("img",{src:t("v3TJ"),alt:""})),o.a.createElement("ol",{start:2},o.a.createElement("li",null,"\u5982\u679c",o.a.createElement("code",null,"hook.queue.pending !=== null"),o.a.createElement("ul",null,o.a.createElement("li",null,"\u904d\u5386",o.a.createElement("code",null,"hook.queue.pending"),"\u961f\u5217, \u63d0\u53d6\u8db3\u591f\u4f18\u5148\u7ea7\u7684",o.a.createElement("code",null,"update"),"\u5bf9\u8c61, \u751f\u6210",o.a.createElement("code",null,"newState")),o.a.createElement("li",null,"\u66f4\u65b0",o.a.createElement("code",null,"hook"),"\u548c",o.a.createElement("code",null,"queue"),"\u5bf9\u8c61\u7684\u76f8\u5173\u5c5e\u6027")))),o.a.createElement("p",null,o.a.createElement("img",{src:t("gpAG"),alt:""})),o.a.createElement("p",null,"\u6700\u540e\u8fd4\u56de\u65b0\u7684\u5143\u7ec4",o.a.createElement("code",null,"[hook.memoizedState, dispatch]")),o.a.createElement(c["a"],{code:"function updateReducer<S, I, A>(\n  reducer: (S, A) => S,\n  initialArg: I,\n  init?: I => S,\n): [S, Dispatch<A>] {\n  const hook = updateWorkInProgressHook();\n  const queue = hook.queue;\n  queue.lastRenderedReducer = reducer;\n  const current: Hook = (currentHook: any);\n  // The last rebase update that is NOT part of the base state.\n  let baseQueue = current.baseQueue;\n  // The last pending update that hasn't been processed yet.\n  const pendingQueue = queue.pending;\n  if (pendingQueue !== null) {\n    // We have new updates that haven't been processed yet.\n    // We'll add them to the base queue.\n    if (baseQueue !== null) {\n      // Merge the pending queue and the base queue.\n      const baseFirst = baseQueue.next;\n      const pendingFirst = pendingQueue.next;\n      baseQueue.next = pendingFirst;\n      pendingQueue.next = baseFirst;\n    }\n    current.baseQueue = baseQueue = pendingQueue;\n    queue.pending = null;\n  }\n\n  if (baseQueue !== null) {\n    // We have a queue to process.\n    const first = baseQueue.next;\n    let newState = current.baseState;\n\n    let newBaseState = null;\n    let newBaseQueueFirst = null;\n    let newBaseQueueLast = null;\n    let update = first;\n    do {\n      const updateExpirationTime = update.expirationTime;\n      if (updateExpirationTime < renderExpirationTime) {\n        // Priority is insufficient. Skip this update. If this is the first\n        // skipped update, the previous update/state is the new base\n        // update/state.\n        const clone: Update<S, A> = {\n          expirationTime: update.expirationTime,\n          suspenseConfig: update.suspenseConfig,\n          action: update.action,\n          eagerReducer: update.eagerReducer,\n          eagerState: update.eagerState,\n          next: (null: any),\n        };\n        if (newBaseQueueLast === null) {\n          newBaseQueueFirst = newBaseQueueLast = clone;\n          newBaseState = newState;\n        } else {\n          newBaseQueueLast = newBaseQueueLast.next = clone;\n        }\n        // Update the remaining priority in the queue.\n        if (updateExpirationTime > currentlyRenderingFiber.expirationTime) {\n          currentlyRenderingFiber.expirationTime = updateExpirationTime;\n          markUnprocessedUpdateTime(updateExpirationTime);\n        }\n      } else {\n        // This update does have sufficient priority.\n\n        if (newBaseQueueLast !== null) {\n          const clone: Update<S, A> = {\n            expirationTime: Sync, // This update is going to be committed so we never want uncommit it.\n            suspenseConfig: update.suspenseConfig,\n            action: update.action,\n            eagerReducer: update.eagerReducer,\n            eagerState: update.eagerState,\n            next: (null: any),\n          };\n          newBaseQueueLast = newBaseQueueLast.next = clone;\n        }\n\n        // Mark the event time of this update as relevant to this render pass.\n        // TODO: This should ideally use the true event time of this update rather than\n        // its priority which is a derived and not reversible value.\n        // TODO: We should skip this update if it was already committed but currently\n        // we have no way of detecting the difference between a committed and suspended\n        // update here.\n        markRenderEventTimeAndConfig(\n          updateExpirationTime,\n          update.suspenseConfig,\n        );\n\n        // Process this update.\n        if (update.eagerReducer === reducer) {\n          // If this update was processed eagerly, and its reducer matches the\n          // current reducer, we can use the eagerly computed state.\n          newState = ((update.eagerState: any): S);\n        } else {\n          const action = update.action;\n          newState = reducer(newState, action);\n        }\n      }\n      update = update.next;\n    } while (update !== null && update !== first);\n\n    if (newBaseQueueLast === null) {\n      newBaseState = newState;\n    } else {\n      newBaseQueueLast.next = (newBaseQueueFirst: any);\n    }\n\n    // Mark that the fiber performed work, but only if the new state is\n    // different from the current state.\n    if (!is(newState, hook.memoizedState)) {\n      markWorkInProgressReceivedUpdate();\n    }\n\n    hook.memoizedState = newState;\n    hook.baseState = newBaseState;\n    hook.baseQueue = newBaseQueueLast;\n\n    queue.lastRenderedState = newState;\n  }\n\n  const dispatch: Dispatch<A> = (queue.dispatch: any);\n  return [hook.memoizedState, dispatch];\n}",lang:"js"}),o.a.createElement("p",null,"\u5bf9\u4e8e",o.a.createElement("code",null,"useEffect"),", \u8c03\u7528",o.a.createElement("code",null,"updateEffectImpl"),":"),o.a.createElement("ol",null,o.a.createElement("li",null,"\u8c03\u7528",o.a.createElement("code",null,"updateWorkInProgressHook"),"\u521b\u5efa\u65b0\u7684",o.a.createElement("code",null,"hook"),"\u5bf9\u8c61",o.a.createElement("ul",null,o.a.createElement("li",null,"\u548c",o.a.createElement("code",null,"useState"),"\u4e2d\u662f\u4e00\u81f4\u7684(\u4e0d\u540c\u7684\u662f, \u901a\u8fc7",o.a.createElement("code",null,"useEffect"),"\u521b\u5efa\u7684",o.a.createElement("code",null,"hook"),"\u5bf9\u8c61,",o.a.createElement("code",null,"hook.queue = null"),")")))),o.a.createElement("p",null,o.a.createElement("img",{src:t("AbAg"),alt:""})),o.a.createElement("ol",{start:2},o.a.createElement("li",null,o.a.createElement("p",null,"\u751f\u6210\u65b0\u7684",o.a.createElement("code",null,"effect"),"\u5bf9\u8c61"),o.a.createElement("ul",null,o.a.createElement("li",null,o.a.createElement("p",null,"hook \u66f4\u65b0,\u5e76\u4e14 deps \u4f9d\u8d56\u4e0d\u53d8."),o.a.createElement("ul",null,o.a.createElement("li",null,"\u751f\u6210\u65b0\u7684",o.a.createElement("code",null,"effect(HookPassive)"),",\u6dfb\u52a0\u5230",o.a.createElement("code",null,"fiber.updateQueue"))),o.a.createElement("p",null,o.a.createElement("img",{src:t("Kn9z"),alt:""}))),o.a.createElement("li",null,o.a.createElement("p",null,"deps \u4f9d\u8d56\u6539\u53d8."),o.a.createElement("ul",null,o.a.createElement("li",null,"\u8bbe\u7f6e",o.a.createElement("code",null,"fiber.effectTag = UpdateEffect | PassiveEffect")),o.a.createElement("li",null,"\u751f\u6210\u65b0\u7684",o.a.createElement("code",null,"effect(HookHasEffect | HookPassive)"),",\u6dfb\u52a0\u5230",o.a.createElement("code",null,"fiber.updateQueue"))),o.a.createElement("p",null,o.a.createElement("img",{src:t("1XtG"),alt:""})))))),o.a.createElement(c["a"],{code:"function updateEffectImpl(fiberEffectTag, hookEffectTag, create, deps): void {\n  const hook = updateWorkInProgressHook();\n  const nextDeps = deps === undefined ? null : deps;\n  let destroy = undefined;\n  if (currentHook !== null) {\n    // hook\u66f4\u65b0\n    const prevEffect = currentHook.memoizedState;\n    destroy = prevEffect.destroy;\n    if (nextDeps !== null) {\n      const prevDeps = prevEffect.deps;\n      if (areHookInputsEqual(nextDeps, prevDeps)) {\n        // deps\u4f9d\u8d56\u4e00\u81f4\n        pushEffect(hookEffectTag, create, destroy, nextDeps);\n        return;\n      }\n    }\n  }\n  // \u65b0\u589ehook, \u6216\u8005deps\u4f9d\u8d56\u6539\u53d8\n  // 1. \u8bbe\u7f6efiber.effectTag = UpdateEffect | PassiveEffect\n  currentlyRenderingFiber.effectTag |= fiberEffectTag;\n  // 2. \u8bbe\u7f6ehook.memoizedState\n  hook.memoizedState = pushEffect(\n    HookHasEffect | hookEffectTag,\n    create,\n    destroy,\n    nextDeps,\n  );\n}",lang:"js"}),o.a.createElement("p",null,"\u6574\u4e2a",o.a.createElement("code",null,"hook"),"\u7684\u66f4\u65b0\u8fc7\u7a0b\u53ef\u4ee5\u5982\u4e0b\u8868\u793a:"),o.a.createElement("p",null,"\u5de6\u8fb9\u662f",o.a.createElement("code",null,"current"),"\u53f3\u8fb9\u662f",o.a.createElement("code",null,"workInProgress")),o.a.createElement("p",null,o.a.createElement("img",{src:t("LA/F"),alt:""})),o.a.createElement("p",null,"\u6ce8\u610f\u6d45\u84dd\u8272\u80cc\u666f\u7684",o.a.createElement("code",null,"updateQueue"),"\u961f\u5217\u4e2d, \u65b0",o.a.createElement("code",null,"effect"),"\u4f1a\u5f15\u7528\u65e7",o.a.createElement("code",null,"effect"),"\u5bf9\u8c61\u7684",o.a.createElement("code",null,"destroy"),"\u65b9\u6cd5."))))}));n["default"]=e=>{var n=o.a.useContext(l["context"]),t=n.demos;return o.a.useEffect((()=>{var n;null!==e&&void 0!==e&&null!==(n=e.location)&&void 0!==n&&n.hash&&l["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),o.a.createElement(u,{demos:t})}},gpAG:function(e,n,t){e.exports=t.p+"static/useState-update-WorkInProgressHook.eba58ac7.png"},v3TJ:function(e,n,t){e.exports=t.p+"static/useState-create-WorkInProgressHook.3203c37f.png"}}]);
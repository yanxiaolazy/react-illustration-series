(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[20],{"5lQ+":function(e,t,n){e.exports=n.p+"static/async-update-before-combine.c8c229b4.png"},"62xH":function(e,t,n){e.exports=n.p+"static/initial-state.873a205e.png"},"8lOB":function(e,t,n){e.exports=n.p+"static/async-update-after-combine.5e9e7d7e.png"},J2wX:function(e,t,n){e.exports=n.p+"static/state-compute.f65e2693.png"},LRti:function(e,t,n){e.exports=n.p+"static/async-final-compute.161d30b7.png"},MG9h:function(e,t,n){e.exports=n.p+"static/async-update-state-compute.bb865b44.png"},MZF8:function(e,t,n){"use strict";var a=n("ogwx");n.d(t,"a",(function(){return a["b"]}));n("VCU9")},Wuxq:function(e,t,n){e.exports=n.p+"static/async-final-combine.1869a352.png"},"a+rx":function(e,t,n){e.exports=n.p+"static/after-basequeue-combine.1f0a9771.png"},cP1e:function(e,t,n){"use strict";n.r(t);var a=n("q1tI"),l=n.n(a),c=n("dEAq"),r=n("Zxc8"),u=n("H1Ra"),o=l.a.memo((e=>{var t=e.demos,a=t["hook-state-demo"].component;return l.a.createElement(l.a.Fragment,null,l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"markdown"},l.a.createElement("h1",{id:"hook-\u539f\u7406\u72b6\u6001-hook"},l.a.createElement(c["AnchorLink"],{to:"#hook-\u539f\u7406\u72b6\u6001-hook","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"Hook \u539f\u7406(\u72b6\u6001 Hook)"),l.a.createElement("p",null,"\u9996\u5148\u56de\u987e\u4e00\u4e0b\u524d\u6587",l.a.createElement(c["Link"],{to:"./hook-summary"},"Hook \u539f\u7406(\u6982\u89c8)"),", \u5176\u4e3b\u8981\u5185\u5bb9\u6709:"),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("code",null,"function"),"\u7c7b\u578b\u7684",l.a.createElement("code",null,"fiber"),"\u8282\u70b9, \u5b83\u7684\u5904\u7406\u51fd\u6570\u662f",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L702-L783"},"updateFunctionComponent"),", \u5176\u4e2d\u518d\u901a\u8fc7",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L342-L476"},"renderWithHooks"),"\u8c03\u7528",l.a.createElement("code",null,"function"),"."),l.a.createElement("li",null,"\u5728",l.a.createElement("code",null,"function"),"\u4e2d, \u901a\u8fc7",l.a.createElement("code",null,"Hook Api"),"(\u5982: ",l.a.createElement("code",null,"useState, useEffect"),")\u521b\u5efa",l.a.createElement("code",null,"Hook"),"\u5bf9\u8c61.",l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"\u72b6\u6001Hook"),"\u5b9e\u73b0\u4e86\u72b6\u6001\u6301\u4e45\u5316(\u7b49\u540c\u4e8e",l.a.createElement("code",null,"class\u7ec4\u4ef6"),"\u7ef4\u62a4",l.a.createElement("code",null,"fiber.memoizedState"),")."),l.a.createElement("li",null,l.a.createElement("code",null,"\u526f\u4f5c\u7528Hook"),"\u5219\u5b9e\u73b0\u4e86\u7ef4\u62a4",l.a.createElement("code",null,"fiber.flags"),",\u5e76\u63d0\u4f9b",l.a.createElement("code",null,"\u526f\u4f5c\u7528\u56de\u8c03"),"(\u7c7b\u4f3c\u4e8e",l.a.createElement("code",null,"class\u7ec4\u4ef6"),"\u7684\u751f\u547d\u5468\u671f\u56de\u8c03)"))),l.a.createElement("li",null,"\u591a\u4e2a",l.a.createElement("code",null,"Hook"),"\u5bf9\u8c61\u6784\u6210\u4e00\u4e2a",l.a.createElement("code",null,"\u94fe\u8868\u7ed3\u6784"),", \u5e76\u6302\u8f7d\u5230",l.a.createElement("code",null,"fiber.memoizedState"),"\u4e4b\u4e0a."),l.a.createElement("li",null,l.a.createElement("code",null,"fiber\u6811"),"\u66f4\u65b0\u9636\u6bb5, \u628a",l.a.createElement("code",null,"current.memoizedState"),"\u94fe\u8868\u4e0a\u7684\u6240\u6709",l.a.createElement("code",null,"Hook"),"\u6309\u7167\u987a\u5e8f\u514b\u9686\u5230",l.a.createElement("code",null,"workInProgress.memoizedState"),"\u4e0a, \u5b9e\u73b0\u6570\u636e\u7684\u6301\u4e45\u5316.")),l.a.createElement("p",null,"\u5728\u6b64\u57fa\u7840\u4e4b\u4e0a, \u672c\u8282\u5c06\u6df1\u5165\u5206\u6790",l.a.createElement("code",null,"\u72b6\u6001Hook"),"\u7684\u7279\u6027\u548c\u5b9e\u73b0\u539f\u7406."),l.a.createElement("h2",{id:"\u521b\u5efa-hook"},l.a.createElement(c["AnchorLink"],{to:"#\u521b\u5efa-hook","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u521b\u5efa Hook"),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"fiber"),"\u521d\u6b21\u6784\u9020\u9636\u6bb5, ",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1787"},"useState"),"\u5bf9\u5e94\u6e90\u7801",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1113-L1136"},"mountState"),", ",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1785"},"useReducer"),"\u5bf9\u5e94\u6e90\u7801",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L624-L649"},"mountReducer")),l.a.createElement("p",null,l.a.createElement("code",null,"mountState"),":"),l.a.createElement(u["a"],{code:"function mountState<S>(\n  initialState: (() => S) | S,\n): [S, Dispatch<BasicStateAction<S>>] {\n  // 1. \u521b\u5efahook\n  const hook = mountWorkInProgressHook();\n  if (typeof initialState === 'function') {\n    initialState = initialState();\n  }\n  // 2. \u521d\u59cb\u5316hook\u7684\u5c5e\u6027\n  // 2.1 \u8bbe\u7f6e hook.memoizedState/hook.baseState\n  // 2.2 \u8bbe\u7f6e hook.queue\n  hook.memoizedState = hook.baseState = initialState;\n  const queue = (hook.queue = {\n    pending: null,\n    dispatch: null,\n    // queue.lastRenderedReducer\u662f\u5185\u7f6e\u51fd\u6570\n    lastRenderedReducer: basicStateReducer,\n    lastRenderedState: (initialState: any),\n  });\n  // 2.3 \u8bbe\u7f6e hook.dispatch\n  const dispatch: Dispatch<\n    BasicStateAction<S>,\n  > = (queue.dispatch = (dispatchAction.bind(\n    null,\n    currentlyRenderingFiber,\n    queue,\n  ): any));\n\n  // 3. \u8fd4\u56de[\u5f53\u524d\u72b6\u6001, dispatch\u51fd\u6570]\n  return [hook.memoizedState, dispatch];\n}",lang:"js"}),l.a.createElement("p",null,l.a.createElement("code",null,"mountReducer"),":"),l.a.createElement(u["a"],{code:"function mountReducer<S, I, A>(\n  reducer: (S, A) => S,\n  initialArg: I,\n  init?: I => S,\n): [S, Dispatch<A>] {\n  // 1. \u521b\u5efahook\n  const hook = mountWorkInProgressHook();\n  let initialState;\n  if (init !== undefined) {\n    initialState = init(initialArg);\n  } else {\n    initialState = ((initialArg: any): S);\n  }\n  // 2. \u521d\u59cb\u5316hook\u7684\u5c5e\u6027\n  // 2.1 \u8bbe\u7f6e hook.memoizedState/hook.baseState\n  hook.memoizedState = hook.baseState = initialState;\n  // 2.2 \u8bbe\u7f6e hook.queue\n  const queue = (hook.queue = {\n    pending: null,\n    dispatch: null,\n    // queue.lastRenderedReducer\u662f\u7531\u5916\u4f20\u5165\n    lastRenderedReducer: reducer,\n    lastRenderedState: (initialState: any),\n  });\n  // 2.3 \u8bbe\u7f6e hook.dispatch\n  const dispatch: Dispatch<A> = (queue.dispatch = (dispatchAction.bind(\n    null,\n    currentlyRenderingFiber,\n    queue,\n  ): any));\n\n  // 3. \u8fd4\u56de[\u5f53\u524d\u72b6\u6001, dispatch\u51fd\u6570]\n  return [hook.memoizedState, dispatch];\n}",lang:"js"}),l.a.createElement("p",null,l.a.createElement("code",null,"mountState"),"\u548c",l.a.createElement("code",null,"mountReducer"),"\u903b\u8f91\u7b80\u5355: \u4e3b\u8981\u8d1f\u8d23\u521b\u5efa",l.a.createElement("code",null,"hook"),", \u521d\u59cb\u5316",l.a.createElement("code",null,"hook"),"\u7684\u5c5e\u6027, \u6700\u540e\u8fd4\u56de",l.a.createElement("code",null,"[\u5f53\u524d\u72b6\u6001, dispatch\u51fd\u6570]"),"."),l.a.createElement("p",null,"\u552f\u4e00\u7684\u4e0d\u540c\u70b9\u662f",l.a.createElement("code",null,"hook.queue.lastRenderedReducer"),":"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"mountState"),"\u4f7f\u7528\u7684\u662f\u5185\u7f6e\u7684",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L619-L622"},"basicStateReducer"),l.a.createElement(u["a"],{code:"function basicStateReducer<S>(state: S, action: BasicStateAction<S>): S {\n  return typeof action === 'function' ? action(state) : action;\n}",lang:"js"})),l.a.createElement("li",null,l.a.createElement("code",null,"mountReducer"),"\u4f7f\u7528\u7684\u662f\u5916\u90e8\u4f20\u5165\u81ea\u5b9a\u4e49",l.a.createElement("code",null,"reducer"))),l.a.createElement("p",null,"\u53ef\u89c1",l.a.createElement("code",null,"mountState"),"\u662f",l.a.createElement("code",null,"mountReducer"),"\u7684\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5, \u5373",l.a.createElement("code",null,"useState"),"\u4e5f\u662f",l.a.createElement("code",null,"useReducer"),"\u7684\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5, \u4e5f\u662f\u6700\u7b80\u5355\u7684\u60c5\u51b5."),l.a.createElement("p",null,l.a.createElement("code",null,"useState"),"\u53ef\u4ee5\u8f6c\u6362\u6210",l.a.createElement("code",null,"useReducer"),":"),l.a.createElement(u["a"],{code:"const [state, dispatch] = useState({ count: 0 });\n\n// \u7b49\u4ef7\u4e8e\nconst [state, dispatch] = useReducer(\n  function basicStateReducer(state, action) {\n    return typeof action === 'function' ? action(state) : action;\n  },\n  { count: 0 },\n);\n\n// \u5f53\u9700\u8981\u66f4\u65b0state\u65f6, \u67092\u79cd\u65b9\u5f0f\ndispatch({ count: 1 }); // 1.\u76f4\u63a5\u8bbe\u7f6e\ndispatch(state => ({ count: state.count + 1 })); // 2.\u901a\u8fc7\u56de\u8c03\u51fd\u6570\u8bbe\u7f6e",lang:"js"}),l.a.createElement("p",null,l.a.createElement("code",null,"userReducer"),"\u7684",l.a.createElement(c["Link"],{to:"https://zh-hans.reactjs.org/docs/hooks-reference.html#usereducer"},"\u5b98\u7f51\u793a\u4f8b"),":"),l.a.createElement(u["a"],{code:"const [state, dispatch] = useReducer(\n  function reducer(state, action) {\n    switch (action.type) {\n      case 'increment':\n        return { count: state.count + 1 };\n      case 'decrement':\n        return { count: state.count - 1 };\n      default:\n        throw new Error();\n    }\n  },\n  { count: 0 },\n);\n\n// \u5f53\u9700\u8981\u66f4\u65b0state\u65f6, \u53ea\u67091\u79cd\u65b9\u5f0f\ndispatch({ type: 'decrement' });",lang:"js"}),l.a.createElement("p",null,"\u53ef\u89c1, ",l.a.createElement("code",null,"useState"),"\u5c31\u662f\u5bf9",l.a.createElement("code",null,"useReducer"),"\u7684\u57fa\u672c\u5c01\u88c5, \u5185\u7f6e\u4e86\u4e00\u4e2a\u7279\u6b8a\u7684",l.a.createElement("code",null,"reducer"),"(\u540e\u6587\u4e0d\u518d\u533a\u5206",l.a.createElement("code",null,"useState, useReducer"),", \u90fd\u4ee5",l.a.createElement("code",null,"useState"),"\u4e3a\u4f8b).",l.a.createElement("code",null,"\u521b\u5efahook"),"\u4e4b\u540e\u8fd4\u56de\u503c",l.a.createElement("code",null,"[hook.memoizedState, dispatch]"),"\u4e2d\u7684",l.a.createElement("code",null,"dispatch"),"\u5b9e\u9645\u4e0a\u4f1a\u8c03\u7528",l.a.createElement("code",null,"reducer"),"\u51fd\u6570."),l.a.createElement("h2",{id:"\u72b6\u6001\u521d\u59cb\u5316"},l.a.createElement(c["AnchorLink"],{to:"#\u72b6\u6001\u521d\u59cb\u5316","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u72b6\u6001\u521d\u59cb\u5316"),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"useState(initialState)"),"\u51fd\u6570\u5185\u90e8, \u8bbe\u7f6e",l.a.createElement("code",null,"hook.memoizedState = hook.baseState = initialState;"),", \u521d\u59cb\u72b6\u6001\u88ab\u540c\u65f6\u4fdd\u5b58\u5230\u4e86",l.a.createElement("code",null,"hook.baseState"),",",l.a.createElement("code",null,"hook.memoizedState"),"\u4e2d."),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("code",null,"hook.memoizedState"),": \u5f53\u524d\u72b6\u6001"),l.a.createElement("li",null,l.a.createElement("code",null,"hook.baseState"),": ",l.a.createElement("code",null,"\u57fa\u7840"),"\u72b6\u6001, \u4f5c\u4e3a\u5408\u5e76",l.a.createElement("code",null,"hook.baseQueue"),"\u7684\u521d\u59cb\u503c(\u4e0b\u6587\u4ecb\u7ecd).")),l.a.createElement("p",null,"\u6700\u540e\u8fd4\u56de",l.a.createElement("code",null,"[hook.memoizedState, dispatch]"),", \u6240\u4ee5\u5728",l.a.createElement("code",null,"function"),"\u4e2d\u4f7f\u7528\u7684\u662f",l.a.createElement("code",null,"hook.memoizedState"),"."),l.a.createElement("h2",{id:"\u72b6\u6001\u66f4\u65b0"},l.a.createElement(c["AnchorLink"],{to:"#\u72b6\u6001\u66f4\u65b0","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u72b6\u6001\u66f4\u65b0"),l.a.createElement("p",null,"\u6709\u5982\u4e0b\u4ee3\u7801:",l.a.createElement(c["Link"],{to:"https://codesandbox.io/s/hook-status-vhlf8?fontsize=14&hidenavigation=1&theme=dark"},l.a.createElement("img",{src:"https://codesandbox.io/static/img/play-codesandbox.svg",alt:"Edit hook-status"})))),l.a.createElement(r["default"],t["hook-state-demo"].previewerProps,l.a.createElement(a,null)),l.a.createElement("div",{className:"markdown"},l.a.createElement("p",null,"\u521d\u6b21\u6e32\u67d3\u65f6",l.a.createElement("code",null,"count = 0"),", \u8fd9\u65f6",l.a.createElement("code",null,"hook"),"\u5bf9\u8c61\u7684\u5185\u5b58\u72b6\u6001\u5982\u4e0b:"),l.a.createElement("p",null,l.a.createElement("img",{src:n("62xH"),alt:""})),l.a.createElement("p",null,"\u70b9\u51fb",l.a.createElement("code",null,"button"),", \u901a\u8fc7",l.a.createElement("code",null,"dispatch"),"\u51fd\u6570\u8fdb\u884c\u66f4\u65b0, ",l.a.createElement("code",null,"dispatch"),"\u5b9e\u9645\u5c31\u662f",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1645-L1753"},"dispatchAction"),":"),l.a.createElement(u["a"],{code:"function dispatchAction<S, A>(\n  fiber: Fiber,\n  queue: UpdateQueue<S, A>,\n  action: A,\n) {\n  // 1. \u521b\u5efaupdate\u5bf9\u8c61\n  const eventTime = requestEventTime();\n  const lane = requestUpdateLane(fiber); // Legacy\u6a21\u5f0f\u8fd4\u56deSyncLane\n  const update: Update<S, A> = {\n    lane,\n    action,\n    eagerReducer: null,\n    eagerState: null,\n    next: (null: any),\n  };\n\n  // 2. \u5c06update\u5bf9\u8c61\u6dfb\u52a0\u5230hook.queue.pending\u961f\u5217\n  const pending = queue.pending;\n  if (pending === null) {\n    // \u9996\u4e2aupdate, \u521b\u5efa\u4e00\u4e2a\u73af\u5f62\u94fe\u8868\n    update.next = update;\n  } else {\n    update.next = pending.next;\n    pending.next = update;\n  }\n  queue.pending = update;\n\n  const alternate = fiber.alternate;\n  if (\n    fiber === currentlyRenderingFiber ||\n    (alternate !== null && alternate === currentlyRenderingFiber)\n  ) {\n    // \u6e32\u67d3\u65f6\u66f4\u65b0, \u505a\u597d\u5168\u5c40\u6807\u8bb0\n    didScheduleRenderPhaseUpdateDuringThisPass = didScheduleRenderPhaseUpdate = true;\n  } else {\n    // ...\u7701\u7565\u6027\u80fd\u4f18\u5316\u90e8\u5206, \u4e0b\u6587\u4ecb\u7ecd\n\n    // 3. \u53d1\u8d77\u8c03\u5ea6\u66f4\u65b0, \u8fdb\u5165`reconciler \u8fd0\u4f5c\u6d41\u7a0b`\u4e2d\u7684\u8f93\u5165\u9636\u6bb5.\n    scheduleUpdateOnFiber(fiber, lane, eventTime);\n  }\n}",lang:"js"}),l.a.createElement("p",null,"\u903b\u8f91\u5341\u5206\u6e05\u6670:"),l.a.createElement("ol",null,l.a.createElement("li",null,"\u521b\u5efa",l.a.createElement("code",null,"update"),"\u5bf9\u8c61, \u5176\u4e2d",l.a.createElement("code",null,"update.lane"),"\u4ee3\u8868\u4f18\u5148\u7ea7(\u53ef\u56de\u987e",l.a.createElement(c["AnchorLink"],{to:"./fibertree-prepare#update-lane"},"fiber \u6811\u6784\u9020(\u57fa\u7840\u51c6\u5907)"),"\u4e2d\u7684",l.a.createElement("code",null,"update\u4f18\u5148\u7ea7"),")."),l.a.createElement("li",null,"\u5c06",l.a.createElement("code",null,"update"),"\u5bf9\u8c61\u6dfb\u52a0\u5230",l.a.createElement("code",null,"hook.queue.pending"),"\u73af\u5f62\u94fe\u8868.",l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"\u73af\u5f62\u94fe\u8868"),"\u7684\u7279\u5f81: \u4e3a\u4e86\u65b9\u4fbf\u6dfb\u52a0\u65b0\u5143\u7d20\u548c\u5feb\u901f\u62ff\u5230\u961f\u9996\u5143\u7d20(\u90fd\u662f",l.a.createElement("code",null,"O(1)"),"), \u6240\u4ee5",l.a.createElement("code",null,"pending"),"\u6307\u9488\u6307\u5411\u4e86\u94fe\u8868\u4e2d\u6700\u540e\u4e00\u4e2a\u5143\u7d20."),l.a.createElement("li",null,"\u94fe\u8868\u7684\u4f7f\u7528\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003",l.a.createElement(c["Link"],{to:"../algorithm/linkedlist"},"React \u7b97\u6cd5\u4e4b\u94fe\u8868\u64cd\u4f5c")))),l.a.createElement("li",null,"\u53d1\u8d77\u8c03\u5ea6\u66f4\u65b0: \u8c03\u7528",l.a.createElement("code",null,"scheduleUpdateOnFiber"),", \u8fdb\u5165",l.a.createElement("code",null,"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),"\u4e2d\u7684\u8f93\u5165\u9636\u6bb5.")),l.a.createElement("p",null,"\u4ece\u8c03\u7528",l.a.createElement("code",null,"scheduleUpdateOnFiber"),"\u5f00\u59cb, \u8fdb\u5165\u4e86",l.a.createElement("code",null,"react-reconciler"),"\u5305, \u5176\u4e2d\u7684\u6240\u6709\u903b\u8f91\u53ef\u56de\u987e",l.a.createElement(c["Link"],{to:"./reconciler-workflow"},"reconciler \u8fd0\u4f5c\u6d41\u7a0b"),", \u672c\u8282\u53ea\u8ba8\u8bba",l.a.createElement("code",null,"\u72b6\u6001Hook"),"\u76f8\u5173\u903b\u8f91."),l.a.createElement("p",null,"\u6ce8\u610f: \u672c\u793a\u4f8b\u4e2d\u867d\u7136\u540c\u65f6\u6267\u884c\u4e86 3 \u6b21 dispatch, \u4f1a\u8bf7\u6c42 3 \u6b21\u8c03\u5ea6, \u7531\u4e8e\u8c03\u5ea6\u4e2d\u5fc3\u7684",l.a.createElement(c["AnchorLink"],{to:"./scheduler##throttle-debounce"},"\u8282\u6d41\u4f18\u5316"),", \u6700\u540e\u53ea\u4f1a\u6267\u884c\u4e00\u6b21\u6e32\u67d3"),l.a.createElement("p",null,"\u5728",l.a.createElement("code",null,"fiber\u6811\u6784\u9020(\u5bf9\u6bd4\u66f4\u65b0)"),"\u8fc7\u7a0b\u4e2d, \u518d\u6b21\u8c03\u7528",l.a.createElement("code",null,"function"),", \u8fd9\u65f6",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1808"},"useState"),"\u5bf9\u5e94\u7684\u51fd\u6570\u662f",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1138-L1142"},"updateState")),l.a.createElement(u["a"],{code:"function updateState<S>(\n  initialState: (() => S) | S,\n): [S, Dispatch<BasicStateAction<S>>] {\n  return updateReducer(basicStateReducer, (initialState: any));\n}",lang:"js"}),l.a.createElement("p",null,"\u5b9e\u9645\u8c03\u7528",l.a.createElement(c["Link"],{to:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L651-L783"},"updateReducer"),"."),l.a.createElement("p",null,"\u5728\u6267\u884c",l.a.createElement("code",null,"updateReducer"),"\u4e4b\u524d, ",l.a.createElement("code",null,"hook"),"\u76f8\u5173\u7684\u5185\u5b58\u7ed3\u6784\u5982\u4e0b:"),l.a.createElement("p",null,l.a.createElement("img",{src:n("w59u"),alt:""})),l.a.createElement(u["a"],{code:"function updateReducer<S, I, A>(\n  reducer: (S, A) => S,\n  initialArg: I,\n  init?: I => S,\n): [S, Dispatch<A>] {\n  // 1. \u83b7\u53d6workInProgressHook\u5bf9\u8c61\n  const hook = updateWorkInProgressHook();\n  const queue = hook.queue;\n  queue.lastRenderedReducer = reducer;\n  const current: Hook = (currentHook: any);\n  let baseQueue = current.baseQueue;\n\n  // 2. \u94fe\u8868\u62fc\u63a5: \u5c06 hook.queue.pending \u62fc\u63a5\u5230 current.baseQueue\n  const pendingQueue = queue.pending;\n  if (pendingQueue !== null) {\n    if (baseQueue !== null) {\n      const baseFirst = baseQueue.next;\n      const pendingFirst = pendingQueue.next;\n      baseQueue.next = pendingFirst;\n      pendingQueue.next = baseFirst;\n    }\n    current.baseQueue = baseQueue = pendingQueue;\n    queue.pending = null;\n  }\n  // 3. \u72b6\u6001\u8ba1\u7b97\n  if (baseQueue !== null) {\n    const first = baseQueue.next;\n    let newState = current.baseState;\n\n    let newBaseState = null;\n    let newBaseQueueFirst = null;\n    let newBaseQueueLast = null;\n    let update = first;\n\n    do {\n      const updateLane = update.lane;\n      // 3.1 \u4f18\u5148\u7ea7\u63d0\u53d6update\n      if (!isSubsetOfLanes(renderLanes, updateLane)) {\n        // \u4f18\u5148\u7ea7\u4e0d\u591f: \u52a0\u5165\u5230baseQueue\u4e2d, \u7b49\u5f85\u4e0b\u4e00\u6b21render\n        const clone: Update<S, A> = {\n          lane: updateLane,\n          action: update.action,\n          eagerReducer: update.eagerReducer,\n          eagerState: update.eagerState,\n          next: (null: any),\n        };\n        if (newBaseQueueLast === null) {\n          newBaseQueueFirst = newBaseQueueLast = clone;\n          newBaseState = newState;\n        } else {\n          newBaseQueueLast = newBaseQueueLast.next = clone;\n        }\n        currentlyRenderingFiber.lanes = mergeLanes(\n          currentlyRenderingFiber.lanes,\n          updateLane,\n        );\n        markSkippedUpdateLanes(updateLane);\n      } else {\n        // \u4f18\u5148\u7ea7\u8db3\u591f: \u72b6\u6001\u5408\u5e76\n        if (newBaseQueueLast !== null) {\n          // \u66f4\u65b0baseQueue\n          const clone: Update<S, A> = {\n            lane: NoLane,\n            action: update.action,\n            eagerReducer: update.eagerReducer,\n            eagerState: update.eagerState,\n            next: (null: any),\n          };\n          newBaseQueueLast = newBaseQueueLast.next = clone;\n        }\n        if (update.eagerReducer === reducer) {\n          // \u6027\u80fd\u4f18\u5316: \u5982\u679c\u5b58\u5728 update.eagerReducer, \u76f4\u63a5\u4f7f\u7528update.eagerState.\u907f\u514d\u91cd\u590d\u8c03\u7528reducer\n          newState = ((update.eagerState: any): S);\n        } else {\n          const action = update.action;\n          // \u8c03\u7528reducer\u83b7\u53d6\u6700\u65b0\u72b6\u6001\n          newState = reducer(newState, action);\n        }\n      }\n      update = update.next;\n    } while (update !== null && update !== first);\n\n    // 3.2. \u66f4\u65b0\u5c5e\u6027\n    if (newBaseQueueLast === null) {\n      newBaseState = newState;\n    } else {\n      newBaseQueueLast.next = (newBaseQueueFirst: any);\n    }\n    if (!is(newState, hook.memoizedState)) {\n      markWorkInProgressReceivedUpdate();\n    }\n    // \u628a\u8ba1\u7b97\u4e4b\u540e\u7684\u7ed3\u679c\u66f4\u65b0\u5230workInProgressHook\u4e0a\n    hook.memoizedState = newState;\n    hook.baseState = newBaseState;\n    hook.baseQueue = newBaseQueueLast;\n    queue.lastRenderedState = newState;\n  }\n\n  const dispatch: Dispatch<A> = (queue.dispatch: any);\n  return [hook.memoizedState, dispatch];\n}",lang:"js"}),l.a.createElement("p",null,l.a.createElement("code",null,"updateReducer"),"\u51fd\u6570, \u4ee3\u7801\u76f8\u5bf9\u8f83\u957f, \u4f46\u662f\u903b\u8f91\u5206\u660e:"),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("p",null,"\u8c03\u7528",l.a.createElement("code",null,"updateWorkInProgressHook"),"\u83b7\u53d6",l.a.createElement("code",null,"workInProgressHook"),"\u5bf9\u8c61")),l.a.createElement("li",null,l.a.createElement("p",null,"\u94fe\u8868\u62fc\u63a5: \u5c06 ",l.a.createElement("code",null,"hook.queue.pending")," \u62fc\u63a5\u5230 ",l.a.createElement("code",null,"current.baseQueue")),l.a.createElement("p",null,l.a.createElement("img",{src:n("a+rx"),alt:""}))),l.a.createElement("li",null,l.a.createElement("p",null,"\u72b6\u6001\u8ba1\u7b97"),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"update"),"\u4f18\u5148\u7ea7\u4e0d\u591f: \u52a0\u5165\u5230 baseQueue \u4e2d, \u7b49\u5f85\u4e0b\u4e00\u6b21 render")),l.a.createElement("li",null,l.a.createElement("p",null,l.a.createElement("code",null,"update"),"\u4f18\u5148\u7ea7\u8db3\u591f: \u72b6\u6001\u5408\u5e76")),l.a.createElement("li",null,l.a.createElement("p",null,"\u66f4\u65b0\u5c5e\u6027"),l.a.createElement("p",null,l.a.createElement("img",{src:n("J2wX"),alt:""})))))),l.a.createElement("h3",{id:"\u6027\u80fd\u4f18\u5316"},l.a.createElement(c["AnchorLink"],{to:"#\u6027\u80fd\u4f18\u5316","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u6027\u80fd\u4f18\u5316"),l.a.createElement("p",null,l.a.createElement("code",null,"dispatchAction"),"\u51fd\u6570\u4e2d, \u5728\u8c03\u7528",l.a.createElement("code",null,"scheduleUpdateOnFiber"),"\u4e4b\u524d, \u9488\u5bf9",l.a.createElement("code",null,"update"),"\u5bf9\u8c61\u505a\u4e86\u6027\u80fd\u4f18\u5316."),l.a.createElement("ol",null,l.a.createElement("li",null,l.a.createElement("code",null,"queue.pending"),"\u4e2d\u53ea\u5305\u542b\u5f53\u524d",l.a.createElement("code",null,"update"),"\u65f6, \u5373\u5f53\u524d",l.a.createElement("code",null,"update"),"\u662f",l.a.createElement("code",null,"queue.pending"),"\u4e2d\u7684\u7b2c\u4e00\u4e2a",l.a.createElement("code",null,"update")),l.a.createElement("li",null,"\u76f4\u63a5\u8c03\u7528",l.a.createElement("code",null,"queue.lastRenderedReducer"),",\u8ba1\u7b97\u51fa",l.a.createElement("code",null,"update"),"\u4e4b\u540e\u7684 state, \u8bb0\u4e3a",l.a.createElement("code",null,"eagerState")),l.a.createElement("li",null,"\u5982\u679c",l.a.createElement("code",null,"eagerState"),"\u4e0e",l.a.createElement("code",null,"currentState"),"\u76f8\u540c, \u5219\u76f4\u63a5\u9000\u51fa, \u4e0d\u7528\u53d1\u8d77\u8c03\u5ea6\u66f4\u65b0."),l.a.createElement("li",null,"\u5df2\u7ecf\u88ab\u6302\u8f7d\u5230",l.a.createElement("code",null,"queue.pending"),"\u4e0a\u7684",l.a.createElement("code",null,"update"),"\u4f1a\u5728\u4e0b\u4e00\u6b21",l.a.createElement("code",null,"render"),"\u65f6\u518d\u6b21\u5408\u5e76.")),l.a.createElement(u["a"],{code:"function dispatchAction<S, A>(\n  fiber: Fiber,\n  queue: UpdateQueue<S, A>,\n  action: A,\n) {\n  // ...\u7701\u7565\u65e0\u5173\u4ee3\u7801 ...\u53ea\u4fdd\u7559\u6027\u80fd\u4f18\u5316\u90e8\u5206\u4ee3\u7801:\n\n  // \u4e0b\u9762\u8fd9\u4e2aif\u5224\u65ad, \u80fd\u4fdd\u8bc1\u5f53\u524d\u521b\u5efa\u7684update, \u662f`queue.pending`\u4e2d\u7b2c\u4e00\u4e2a`update`. \u4e3a\u4ec0\u4e48? \u53d1\u8d77\u66f4\u65b0\u4e4b\u540efiber.lanes\u4f1a\u88ab\u6539\u52a8(\u53ef\u4ee5\u56de\u987e`fiber \u6811\u6784\u9020(\u5bf9\u6bd4\u66f4\u65b0)`\u7ae0\u8282), \u5982\u679c`fiber.lanes && alternate.lanes`\u6ca1\u6709\u88ab\u6539\u52a8, \u81ea\u7136\u5c31\u662f\u9996\u4e2aupdate\n  if (\n    fiber.lanes === NoLanes &&\n    (alternate === null || alternate.lanes === NoLanes)\n  ) {\n    const lastRenderedReducer = queue.lastRenderedReducer;\n    if (lastRenderedReducer !== null) {\n      let prevDispatcher;\n      const currentState: S = (queue.lastRenderedState: any);\n      const eagerState = lastRenderedReducer(currentState, action);\n      // \u6682\u5b58`eagerReducer`\u548c`eagerState`, \u5982\u679c\u5728render\u9636\u6bb5reducer==update.eagerReducer, \u5219\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u65e0\u9700\u518d\u6b21\u8ba1\u7b97\n      update.eagerReducer = lastRenderedReducer;\n      update.eagerState = eagerState;\n      if (is(eagerState, currentState)) {\n        // \u5feb\u901f\u901a\u9053, eagerState\u4e0ecurrentState\u76f8\u540c, \u65e0\u9700\u8c03\u5ea6\u66f4\u65b0\n        // \u6ce8: update\u5df2\u7ecf\u88ab\u6dfb\u52a0\u5230\u4e86queue.pending, \u5e76\u6ca1\u6709\u4e22\u5f03. \u4e4b\u540e\u9700\u8981\u66f4\u65b0\u7684\u65f6\u5019, \u6b64update\u8fd8\u662f\u4f1a\u8d77\u4f5c\u7528\n        return;\n      }\n    }\n  }\n  // \u53d1\u8d77\u8c03\u5ea6\u66f4\u65b0, \u8fdb\u5165`reconciler \u8fd0\u4f5c\u6d41\u7a0b`\u4e2d\u7684\u8f93\u5165\u9636\u6bb5.\n  scheduleUpdateOnFiber(fiber, lane, eventTime);\n}",lang:"js"}),l.a.createElement("p",null,"\u4e3a\u4e86\u9a8c\u8bc1\u4e0a\u8ff0\u4f18\u5316, \u53ef\u4ee5\u67e5\u770b\u8fd9\u4e2a demo:",l.a.createElement(c["Link"],{to:"https://codesandbox.io/s/hook-throttle-58ly5?fontsize=14&hidenavigation=1&theme=dark"},l.a.createElement("img",{src:"https://codesandbox.io/static/img/play-codesandbox.svg",alt:"Edit hook-throttle"}))),l.a.createElement("h3",{id:"\u5f02\u6b65\u66f4\u65b0"},l.a.createElement(c["AnchorLink"],{to:"#\u5f02\u6b65\u66f4\u65b0","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u5f02\u6b65\u66f4\u65b0"),l.a.createElement("p",null,"\u4e0a\u8ff0\u793a\u4f8b\u90fd\u662f\u4e3a\u5728",l.a.createElement("code",null,"Legacy"),"\u6a21\u5f0f\u4e0b, \u6240\u4ee5\u5747\u4e3a\u540c\u6b65\u66f4\u65b0. \u6240\u4ee5",l.a.createElement("code",null,"update"),"\u5bf9\u8c61\u4f1a\u88ab\u5168\u91cf\u5408\u5e76,",l.a.createElement("code",null,"hook.baseQueue"),"\u548c",l.a.createElement("code",null,"hook.baseState"),"\u5e76\u6ca1\u6709\u8d77\u5230\u5b9e\u8d28\u4f5c\u7528."),l.a.createElement("p",null,"\u867d\u7136\u5728",l.a.createElement("code",null,"v17.x"),"\u7248\u672c\u4e2d, \u5e76\u6ca1\u6709",l.a.createElement("code",null,"Concurrent"),"\u6a21\u5f0f\u7684\u5165\u53e3, \u5373\u5c06\u53d1\u5e03\u7684",l.a.createElement("code",null,"v18.x"),"\u7248\u672c\u5c06\u5168\u9762\u8fdb\u5165\u5f02\u6b65\u65f6\u4ee3, \u6240\u4ee5\u672c\u8282\u63d0\u524d\u68b3\u7406\u4e00\u4e0b",l.a.createElement("code",null,"update"),"\u5f02\u6b65\u5408\u5e76\u7684\u903b\u8f91. \u540c\u65f6\u52a0\u6df1",l.a.createElement("code",null,"hook.baseQueue"),"\u548c",l.a.createElement("code",null,"hook.baseState"),"\u7684\u7406\u89e3."),l.a.createElement("p",null,"\u5047\u8bbe\u6709\u4e00\u4e2a",l.a.createElement("code",null,"queue.pending"),"\u94fe\u8868, \u5176\u4e2d",l.a.createElement("code",null,"update"),"\u4f18\u5148\u7ea7\u4e0d\u540c, ",l.a.createElement("code",null,"\u7eff\u8272"),"\u8868\u793a\u9ad8\u4f18\u5148\u7ea7, ",l.a.createElement("code",null,"\u7070\u8272"),"\u8868\u793a\u4f4e\u4f18\u5148\u7ea7, ",l.a.createElement("code",null,"\u7ea2\u8272"),"\u8868\u793a\u6700\u9ad8\u4f18\u5148\u7ea7."),l.a.createElement("p",null,"\u5728\u6267\u884c",l.a.createElement("code",null,"updateReducer"),"\u4e4b\u524d, ",l.a.createElement("code",null,"hook.memoizedState"),"\u6709\u5982\u4e0b\u7ed3\u6784(\u5176\u4e2d",l.a.createElement("code",null,"update3, update4"),"\u662f\u4f4e\u4f18\u5148\u7ea7):"),l.a.createElement("p",null,l.a.createElement("img",{src:n("5lQ+"),alt:""})),l.a.createElement("p",null,"\u94fe\u8868\u62fc\u63a5:"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u548c\u540c\u6b65\u66f4\u65b0\u65f6\u4e00\u81f4, \u76f4\u63a5\u628a",l.a.createElement("code",null,"queue.pending"),"\u62fc\u63a5\u5230",l.a.createElement("code",null,"current.baseQueue"))),l.a.createElement("p",null,l.a.createElement("img",{src:n("8lOB"),alt:""})),l.a.createElement("p",null,"\u72b6\u6001\u8ba1\u7b97:"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u53ea\u4f1a\u63d0\u53d6",l.a.createElement("code",null,"update1, update2"),"\u8fd9 2 \u4e2a\u9ad8\u4f18\u5148\u7ea7\u7684",l.a.createElement("code",null,"update"),", \u6240\u4ee5\u6700\u540e",l.a.createElement("code",null,"memoizedState=2")),l.a.createElement("li",null,"\u4fdd\u7559\u5176\u4f59\u4f4e\u4f18\u5148\u7ea7\u7684",l.a.createElement("code",null,"update"),", \u7b49\u5f85\u4e0b\u4e00\u6b21",l.a.createElement("code",null,"render")),l.a.createElement("li",null,"\u4ece\u7b2c\u4e00\u4e2a\u4f4e\u4f18\u5148\u7ea7",l.a.createElement("code",null,"update3"),"\u5f00\u59cb, \u968f\u540e\u7684\u6240\u6709",l.a.createElement("code",null,"update"),"\u90fd\u4f1a\u88ab\u6dfb\u52a0\u5230",l.a.createElement("code",null,"baseQueue"),", \u7531\u4e8e",l.a.createElement("code",null,"update2"),"\u5df2\u7ecf\u662f\u9ad8\u4f18\u5148\u7ea7, \u4f1a\u8bbe\u7f6e",l.a.createElement("code",null,"update2.lane=NoLane"),"\u5c06\u4f18\u5148\u7ea7\u5347\u7ea7\u5230\u6700\u9ad8(\u7ea2\u8272\u8868\u793a)."),l.a.createElement("li",null,"\u800c",l.a.createElement("code",null,"baseState"),"\u4ee3\u8868\u7b2c\u4e00\u4e2a\u4f4e\u4f18\u5148\u7ea7",l.a.createElement("code",null,"update3"),"\u4e4b\u524d\u7684",l.a.createElement("code",null,"state"),", \u5728\u672c\u4f8b\u4e2d, ",l.a.createElement("code",null,"baseState=1"))),l.a.createElement("p",null,l.a.createElement("img",{src:n("MG9h"),alt:""})),l.a.createElement("p",null,l.a.createElement("code",null,"function"),"\u8282\u70b9\u88ab\u5904\u7406\u5b8c\u540e, \u9ad8\u4f18\u5148\u7ea7\u7684",l.a.createElement("code",null,"update"),", \u4f1a\u7387\u5148\u88ab\u4f7f\u7528(",l.a.createElement("code",null,"memoizedState=2"),"). \u4e00\u6bb5\u65f6\u95f4\u540e, \u4f4e\u4f18\u5148\u7ea7",l.a.createElement("code",null,"update3, update4"),"\u7b26\u5408\u6e32\u67d3, \u8fd9\u79cd\u60c5\u51b5\u4e0b\u518d\u6b21\u6267\u884c",l.a.createElement("code",null,"updateReducer"),"\u91cd\u590d\u4e4b\u524d\u7684\u6b65\u9aa4."),l.a.createElement("p",null,"\u94fe\u8868\u62fc\u63a5:"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u7531\u4e8e",l.a.createElement("code",null,"queue.pending = null"),", \u6545\u62fc\u63a5\u524d\u540e\u6ca1\u6709\u5b9e\u8d28\u53d8\u5316")),l.a.createElement("p",null,l.a.createElement("img",{src:n("Wuxq"),alt:""})),l.a.createElement("p",null,"\u72b6\u6001\u8ba1\u7b97:"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u73b0\u5728\u6240\u6709",l.a.createElement("code",null,"update.lane"),"\u90fd\u7b26\u5408",l.a.createElement("code",null,"\u6e32\u67d3\u4f18\u5148\u7ea7"),", \u6240\u4ee5\u6700\u540e\u7684\u5185\u5b58\u7ed3\u6784\u4e0e\u540c\u6b65\u66f4\u65b0\u4e00\u81f4(",l.a.createElement("code",null,"memoizedState=4,baseState=4"),").")),l.a.createElement("p",null,l.a.createElement("img",{src:n("LRti"),alt:""})),l.a.createElement("blockquote",null,l.a.createElement("p",null,"\u7ed3\u8bba: \u5c3d\u7ba1",l.a.createElement("code",null,"update"),"\u94fe\u8868\u7684\u4f18\u5148\u7ea7\u4e0d\u540c, \u4e2d\u95f4\u7684",l.a.createElement("code",null,"render"),"\u53ef\u80fd\u6709\u591a\u6b21, \u4f46\u6700\u7ec8\u7684\u66f4\u65b0\u7ed3\u679c\u7b49\u4e8e",l.a.createElement("code",null,"update"),"\u94fe\u8868",l.a.createElement("code",null,"\u6309\u987a\u5e8f\u5408\u5e76"),".")),l.a.createElement("h2",{id:"\u603b\u7ed3"},l.a.createElement(c["AnchorLink"],{to:"#\u603b\u7ed3","aria-hidden":"true",tabIndex:-1},l.a.createElement("span",{className:"icon icon-link"})),"\u603b\u7ed3"),l.a.createElement("p",null,"\u672c\u8282\u6df1\u5165\u5206\u6790",l.a.createElement("code",null,"\u72b6\u6001Hook"),"\u5373",l.a.createElement("code",null,"useState"),"\u7684\u5185\u90e8\u539f\u7406, \u4ece",l.a.createElement("code",null,"\u540c\u6b65,\u5f02\u6b65"),"\u66f4\u65b0\u7406\u89e3\u4e86",l.a.createElement("code",null,"update"),"\u5bf9\u8c61\u7684\u5408\u5e76\u65b9\u5f0f, \u6700\u7ec8\u7ed3\u679c\u5b58\u50a8\u5728",l.a.createElement("code",null,"hook.memoizedState"),"\u4f9b\u7ed9",l.a.createElement("code",null,"function"),"\u4f7f\u7528."))))}));t["default"]=e=>{var t=l.a.useContext(c["context"]),n=t.demos;return l.a.useEffect((()=>{var t;null!==e&&void 0!==e&&null!==(t=e.location)&&void 0!==t&&t.hash&&c["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),l.a.createElement(o,{demos:n})}},w59u:function(e,t,n){e.exports=n.p+"static/before-basequeue-combine.aa99bd25.png"}}]);